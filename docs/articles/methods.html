<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Details of methods behind survextrap • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Details of methods behind survextrap">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.15</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cetuximab.html">Case study of using survextrap: cetuximab for head and neck cancer</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
    <a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a>
    <a class="dropdown-item" href="../articles/sbc.html">Simulation-based calibration of survextrap</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Details of methods behind survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/methods.Rmd" class="external-link"><code>vignettes/methods.Rmd</code></a></small>
      <div class="d-none name"><code>methods.Rmd</code></div>
    </div>

    
    
<p>See the <a href="../index.html">README</a> for the design principles
of the package, and the <a href="examples.html">examples vignette</a>
for examples of how to fit models. A more formal account of the methods
is given in the preprint <a href="https://doi.org/10.1186/s12874-023-02094-1" class="external-link">paper</a>.</p>
<div class="section level2">
<h2 id="m-splines">M-splines<a class="anchor" aria-label="anchor" href="#m-splines"></a>
</h2>
<p>The axis of time is split into a set of regions defined by
<em>knots</em>. In the example below, the knots are located at the
integers from 1 to 10, as shown by the grid lines.</p>
<p>Each region is associated with a <em>cubic polynomial function</em>
<span class="math inline">\(b_i(t)\)</span>, known as a <em>basis</em>
function. M-spline basis functions are defined to be positive.</p>
<p>The hazard <span class="math inline">\(h(t)\)</span> at time <span class="math inline">\(t\)</span> is defined by a <em>weighted sum</em>
of the basis functions:</p>
<p><span class="math display">\[h(t) = \eta \sum_i p_i
b_i(t)\]</span></p>
<p>with</p>
<ul>
<li><p>weights <span class="math inline">\(p_1,\ldots,p_n\)</span> that
sum to 1, <span class="math inline">\(\sum_i p_i = 1\)</span>, known as
the <em>basis coefficients</em>.</p></li>
<li><p>a <em>scale</em> parameter <span class="math inline">\(\eta\)</span> that describes the average level of
the hazard.</p></li>
</ul>
<div class="section level3">
<h3 id="standard-m-spline-basis">Standard M-spline basis<a class="anchor" aria-label="anchor" href="#standard-m-spline-basis"></a>
</h3>
<p>In the standard basis, 10 knots implies there are 13 basis functions.
Two of the basis functions have peaks at 0 and the upper knot, and the
others have peaks around the knot, diminishing to zero on either side.
See <a href="https://www.jstor.org/stable/2245395" class="external-link">Ramsay</a> for the
exact definitions of <span class="math inline">\(b_i(t)\)</span>.</p>
<p>The package provides a few functions
(e.g. <code><a href="../reference/mspline_plotdata.html">mspline_plotdata()</a></code>, <code><a href="../reference/plot_mspline.html">plot_mspline()</a></code>) to
illustrate M-spline bases. The actual computation of the basis is done
with the <a href="https://cran.r-project.org/web/packages/splines2/index.html" class="external-link">splines2</a>
package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, degree<span class="op">=</span><span class="fl">3</span>, bsmooth<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs</a></span><span class="op">(</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="va">p_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">13</span>, <span class="fl">13</span><span class="op">)</span></span>
<span><span class="va">haz_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_plotdata.html">mspline_plotdata</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, scale<span class="op">=</span><span class="fl">10</span>, coefs <span class="op">=</span> <span class="va">p_const</span>, bsmooth <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, bsmooth<span class="op">=</span><span class="cn">FALSE</span>, scale<span class="op">=</span><span class="fl">10</span>, coefs <span class="op">=</span> <span class="va">p_naive</span>, tmax<span class="op">=</span><span class="fl">11</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, data<span class="op">=</span><span class="va">haz_unif</span>, color<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">2</span>, y<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"red"</span>, label<span class="op">=</span><span class="st">"h(t): coefficients `p_const`"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1.5</span>, y<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"h(t): coefficients `p_naive`"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time t"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard rate"</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
</div>
<div class="section level3">
<h3 id="smoothed-m-spline-basis">Smoothed M-spline basis<a class="anchor" aria-label="anchor" href="#smoothed-m-spline-basis"></a>
</h3>
<p>An alternative basis is provided which is smoother at the upper knot
(defined by having zero derivative and second derivative at this point).
This is selected by setting <code>bsmooth=TRUE</code> in the various
package functions for defining M-splines.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, degree<span class="op">=</span><span class="fl">3</span>, bsmooth<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">p_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs</a></span><span class="op">(</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="va">p_naive</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">11</span>, <span class="fl">11</span><span class="op">)</span></span>
<span><span class="va">haz_unif</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_plotdata.html">mspline_plotdata</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, scale<span class="op">=</span><span class="fl">1</span>, </span>
<span>                             coefs <span class="op">=</span> <span class="va">p_const</span>, bsmooth <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">mspline</span><span class="op">$</span><span class="va">knots</span>, bsmooth<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>             scale<span class="op">=</span><span class="fl">1</span>, coefs <span class="op">=</span> <span class="va">p_naive</span>, tmax<span class="op">=</span><span class="fl">11</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, data<span class="op">=</span><span class="va">haz_unif</span>, </span>
<span>              color<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.5</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">2</span>, y<span class="op">=</span><span class="fl">1.5</span>, color<span class="op">=</span><span class="st">"red"</span>, </span>
<span>             label<span class="op">=</span><span class="st">"h(t): coefficients `p_const`"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1.5</span>, y<span class="op">=</span><span class="fl">2.5</span>, color<span class="op">=</span><span class="st">"blue"</span>, label<span class="op">=</span><span class="st">"h(t): coefficients `p_naive`"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Time t"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard rate"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
</div>
<div class="section level2">
<h2 id="using-m-splines-to-represent-particular-hazard-shapes">Using M-splines to represent particular hazard shapes<a class="anchor" aria-label="anchor" href="#using-m-splines-to-represent-particular-hazard-shapes"></a>
</h2>
<p>The coefficients <span class="math inline">\(p_i\)</span> define how
the hazard changes through time. If knots are equally spaced, then <span class="math inline">\(p_i\)</span> are nearly proportional to the hazard
in the <span class="math inline">\(i\)</span>th region, so that if all
<span class="math inline">\(p_i\)</span> are equal, then the hazard is
nearly constant (red line <code>p_equal</code> in the figure). It is not
exactly constant because of the influence of the regions at either end
of the space, whose polynomial functions have a skewed shape.</p>
<p>To produce a practically constant hazard, we can search numerically
for the <span class="math inline">\(p_i\)</span> which minimise the
variance of a selection of points <span class="math inline">\(t\)</span>
that span the area that we want to model. This search can be done
automatically in the package (red line <code>p_const</code> in the
figure).</p>
<p><strong>Extrapolation?</strong> To fully specify a parametric
time-to-event model, we have to define the hazard for times greater than
the time <span class="math inline">\(t_{n}\)</span> of the highest knot,
which is 10 in the example.</p>
<p>The model in <code>survextrap</code> simply assumes that the hazard
for <span class="math inline">\(t &gt; t_{n}\)</span> is constant, the
same as the hazard at <span class="math inline">\(t_{n}\)</span>.</p>
<p>Therefore, if you want to estimate survival over a period where you
think the hazard might not be constant, then you should make sure that
the highest spline knot <span class="math inline">\(t_n\)</span> is
after the end of this period.</p>
<blockquote>
<p><strong>Sidenote</strong>. Another way to define the hazard beyond
the last knot would be to extrapolate the final basis polynomials. This
is how <a href="https://cran.r-project.org/web/packages/splines2/index.html" class="external-link">splines2</a>
would compute the basis outside the boundary, but this is not
implemented in <code>survextrap</code>. Although it would lead to a more
smoothly extrapolated hazard, it would be driven by data just before the
boundary, and would be making opaque assumptions about how the hazard
changes after the boundary. The idea behind the package is to make all
assumptions explicit as data or mechanisms.</p>
</blockquote>
<p>Examples of doing this with different kinds of data and knowledge are
given in <code><a href="../articles/examples.html">vignette("examples")</a></code>.</p>
<p>Another arbitrary example of an M-spline curve, more wiggly than the
one above:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_mspline.html">plot_mspline</a></span><span class="op">(</span>knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>     coefs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.5</span>, <span class="fl">0.1</span>, <span class="fl">2</span>, <span class="fl">0.6</span><span class="op">)</span>, tmax<span class="op">=</span><span class="fl">10</span>, bsmooth<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<div class="section level3">
<h3 id="why-not-other-kinds-of-spline">Why not other kinds of spline?<a class="anchor" aria-label="anchor" href="#why-not-other-kinds-of-spline"></a>
</h3>
<ul>
<li><p>The Royston/Parmar model (e.g. in <code>flexsurv</code>) uses a
natural cubic spline for the log cumulative hazard function. A
cumulative hazard is defined to be a non-decreasing function, but the
spline is not constrained. The constraint is handled during fitting the
model - spline coefficients which imply decreasing cumulative hazard
functions are rejected. This is inefficient. A worse problem for
Bayesian analysis of this model is that it is unclear how to specify
priors - a meaningful joint prior on the coefficients would have to rule
out invalid combinations.</p></li>
<li><p>We could also have placed an unrestricted spline, of any kind, on
the log hazard. The disadvantage with this is that the cumulative hazard
(required to obtain the likelihood for censored data) then has to be
evaluated by numerical integration, which is slow.</p></li>
<li><p>The advantage of putting an M-spline on the hazard is that it
respects the constraint that a hazard has to be non-negative, while it
can be integrated analytically to produce the cumulative
hazard.</p></li>
<li><p>A remaining disadvantage of M-splines is that they still rely on
a choice of knot locations. For modelling data, knots are generally
chosen to give equal amounts of data between the knots. The user just
has to define the number of knots. This approach generally works well in
practice.</p></li>
<li><p>There are many different kinds of arbitrarily-flexible model
(fractional polynomials, particular kinds of spline), which are all
designed to fit the data very well. In practice, they may differ in
their computational efficiency, and how easily we can construct priors
for their parameters. Priors will be influential in the places where
there are no data. Though for any model we can use simulation to
calibrate priors to meaningful beliefs - see the <a href="priors.html">priors vignette</a> for examples. For extrapolation,
we don’t want to rely on opaque nuances of the functional forms used in
specific model families. Splines are at least computationally and
conceptually simpler than other kinds of flexible model families,
e.g. Gaussian or Dirichlet processes.</p></li>
</ul>
</div>
</div>
<div class="section level2">
<h2 id="bayesspec">Bayesian model specification<a class="anchor" aria-label="anchor" href="#bayesspec"></a>
</h2>
<p>The <em>parameters</em> of the model, <span class="math inline">\(p_i\)</span> and <span class="math inline">\(\eta\)</span>, are estimated from data using
Bayesian inference.</p>
<p>The <em>flexibility</em> of the fitted model is determined by two
things.</p>
<ol style="list-style-type: lower-alpha">
<li><p>The number <span class="math inline">\(n\)</span> and choice of
knots. This determines the <em>maximum potential flexibility</em> of the
hazard function.</p></li>
<li><p>The <em>prior distribution</em> on the basis coefficients <span class="math inline">\(p_i\)</span>. This plays the role of
<em>smoothing</em> the fitted hazard function.</p></li>
</ol>
<p>The default approach taken by <code>survextrap</code> is to choose a
large number of knots and basis functions (the default is <span class="math inline">\(n=10\)</span>), intended to accommodate all
reasonable situations, and then <em>estimate</em> the extent of
smoothing needed from the data.</p>
<ul>
<li><p>With <em>more data</em>, the fitted curve is as flexible as
necessary to represent the data.</p></li>
<li><p>With <em>less data</em>, the fit is influenced more by the
prior.</p></li>
</ul>
<p>This is a smoother, Bayesian analogue of the common approach to
spline model selection based on choosing <span class="math inline">\(n\)</span> to give the model with the lowest AIC.
It also similar in principle to the “penalised likelihood” methods
implemented in e.g. the <code>mgcv</code> and <code>rstpm2</code>
packages.</p>
<p>All priors in the package can be chosen by the user (within given
distribution families). See the <a href="priors.html">priors
vignette</a> for examples and advice for doing this. The defaults in the
package are all weakly informative, and should be reasonable if there
are enough data, but to promote transparency of the analysis it is
advised to think what priors might be reasonable and specify them
explicitly.</p>
</div>
<div class="section level2">
<h2 id="priorhaz">Prior distribution for the hazard curve<a class="anchor" aria-label="anchor" href="#priorhaz"></a>
</h2>
<p>A log-normal prior is used for the scale <span class="math inline">\(\eta\)</span>. The default in the package is
normal(0, 20) for <span class="math inline">\(\log(\eta)\)</span>.</p>
<p>The prior for the basis coefficients <span class="math inline">\(p_i\)</span>, that describe the mass of the hazard
in each region, is specified on the multinomial logistic scale, since
<span class="math inline">\(\sum_i p_i = 1\)</span>. Define <span class="math inline">\(log(p_i / p_1) = \gamma_i\)</span>, with <span class="math inline">\(\gamma_1=0\)</span>, and <span class="math inline">\(\gamma_i = \mu_i + \sigma\epsilon_i\)</span>, for
<span class="math inline">\(i = 2, \ldots, n\)</span>. The prior has the
following parameters:</p>
<ol style="list-style-type: lower-alpha">
<li><p><strong>Prior mean</strong>: <span class="math inline">\(\boldsymbol{\mu} = (\mu_2,\ldots,\mu_n)\)</span>.
By default, this is determined from the special set of <span class="math inline">\(p_i\)</span> that result in a <em>constant
hazard</em> <span class="math inline">\(h(t)\)</span>. See the
<code><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs()</a></code> function in the package to compute
this.</p></li>
<li>
<p><strong>Prior variability</strong>: <span class="math inline">\(\sigma\)</span> controls the smoothness of the
fitted hazard curve.</p>
<ul>
<li><p>If <span class="math inline">\(\sigma=0\)</span>, then we are
certain that the hazard function (before being scaled by <span class="math inline">\(\eta\)</span>) is the one defined by <span class="math inline">\(\boldsymbol{\mu}\)</span>. By default this is a
constant hazard.</p></li>
<li><p>Values of <span class="math inline">\(\sigma\)</span> around 1
favour wiggly curves, such that the fitted hazard curve is driven mainly
by the the observed data.</p></li>
<li><p>For <em>very</em> high values of <span class="math inline">\(\sigma\)</span>, the hazard is dominated by a
random one of the <span class="math inline">\(n\)</span> basis
functions, which will not typically be useful in practice.</p></li>
</ul>
</li>
<li>
<p><strong>A “random effect”</strong>: <span class="math inline">\(\epsilon_i\)</span>, which describes how much the
<span class="math inline">\(i\)</span>th basis coefficient departs from
the mean, compared to the other basis coefficients. The default is an
“exchangeable” model, with <span class="math inline">\(\epsilon_i \sim
Logistic(0,1)\)</span>, so that the <span class="math inline">\(\gamma_i\)</span> are conditionally independent
given <span class="math inline">\(\mu_i\)</span> and <span class="math inline">\(\sigma\)</span>.</p>
<p>An alternative, smoother model can be specified to relate the basis
coefficients, using a random walk that constrains the <span class="math inline">\(\gamma_i\)</span> closer to each other in time to
be more similar to each other. This model is generated as <span class="math inline">\(\epsilon_1=0\)</span>, and <span class="math inline">\(\epsilon_i \sim Logistic(\epsilon_{i-1},
w_i)\)</span> for any <span class="math inline">\(i \geq 2\)</span>. The
weight <span class="math inline">\(w_i\)</span> accounts for the
difference in the time periods described by coefficients <span class="math inline">\(i\)</span> and <span class="math inline">\(i-1\)</span>. This ensures that we are less
inclined to allow hazard variations in regions of time where the knots
are more closely-spaced, leading to a more realistically smooth function
than if these weights were excluded. The exact definition of <span class="math inline">\(w_i\)</span> is given in <a href="https://arxiv.org/abs/2401.12640" class="external-link">Phillippo et al. 2024</a>,
following principles from <a href="https://arxiv.org/pdf/2201.06808" class="external-link">Li
and Cao 2022</a>.</p>
</li>
</ol>
<blockquote>
<p><strong>Sidenote</strong>. This multinomial logistic distribution is
similar to a Dirichlet distribution for the <span class="math inline">\(p_i\)</span>, but is slightly better behaved for
how MCMC estimation is done in Stan. The interpretation of <span class="math inline">\(\sigma\)</span> is not completely intuitive, but
there is a function in the package (<code>prior_hsd()</code>) to choose
the prior on <span class="math inline">\(\sigma\)</span> to match
judgements about how much the hazard might vary over time.</p>
</blockquote>
<p>The plots below show samples from the prior distribution for the
hazard functions implied by two choices of the joint prior distribution
for <span class="math inline">\(\eta\)</span> and <span class="math inline">\(p\)</span>. In both, <span class="math inline">\(\eta\)</span> is log normal(0,1), which supports
hazard rates between about 0.1 and 7, and the prior mean for <span class="math inline">\(p\)</span> is the special set that is centred
around a constant hazard. The two samples differ by the choice of prior
variability. <span class="math inline">\(\sigma \sim
Gamma(2,40)\)</span> strongly favours low values of <span class="math inline">\(\sigma\)</span>, which forces the hazard to be
nearly uniform, while <span class="math inline">\(\sigma \sim
Gamma(2,1)\)</span> allows a wide range of wiggly shapes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knots</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span></span>
<span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span><span class="op">)</span></span>
<span><span class="va">p_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs</a></span><span class="op">(</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_sample_hazard.html">plot_prior_hazard</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">knots</span><span class="op">)</span>, </span>
<span>                        coefs_mean <span class="op">=</span> <span class="va">p_mean</span>,</span>
<span>                        prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">40</span><span class="op">)</span>,      </span>
<span>                        prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span>  </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span> <span class="op">~</span> <span class="st">" ~ Gamma(2,40)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_sample_hazard.html">plot_prior_hazard</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">knots</span>, tmax<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">knots</span><span class="op">)</span>, </span>
<span>                        coefs_mean <span class="op">=</span> <span class="va">p_mean</span>,</span>
<span>                        prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,       </span>
<span>                        prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                        nsim<span class="op">=</span><span class="fl">10</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/bquote.html" class="external-link">bquote</a></span><span class="op">(</span><span class="va">sigma</span> <span class="op">~</span> <span class="st">"~ Gamma(2,1)"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">gridExtra</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gridExtra/man/arrangeGrob.html" class="external-link">grid.arrange</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, nrow<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>By default, the package estimates <span class="math inline">\(\sigma\)</span> as part of the full Bayesian model
(with a gamma(2,1) prior), so that uncertainty about the level of
smoothness is accounted for.</p>
<p>If sampling is poor, then this alternative procedure might work - fit
the model in two steps (“empirical Bayes”):</p>
<ol style="list-style-type: decimal">
<li><p>A “training” model fit is perfomed, where a prior is placed on
<span class="math inline">\(\sigma\)</span>, and the maximum a
posteriori estimate <span class="math inline">\(\hat\sigma\)</span> of
<span class="math inline">\(\sigma\)</span> is determined.</p></li>
<li><p>A “final” model is then fitted, in which <span class="math inline">\(\sigma\)</span> is fixed to <span class="math inline">\(\hat\sigma\)</span>, giving the “optimal” amount
of smoothness for the hazard <span class="math inline">\(h(t)\)</span>.</p></li>
</ol>
<p>The default choices in the package seems to under-smooth in some
cases. Though it may not matter if the hazard function is
under-smoothed, if the purpose of the model is to estimate a quantity
that is an average over time (e.g. mean survival).</p>
<p>A sensible route to resolving these uncertainties might be use
cross-validation to assess and choose between model specifications. The
package provides an interface to the <a href="https://mc-stan.org/users/interfaces/loo" class="external-link">LOO-CV</a> method for
Bayesian cross-validation - though note that this only assesses fit to
the individual-level data, using the same principle as AIC.</p>
</div>
<div class="section level2">
<h2 id="choice-of-knots-when-modelling-data">Choice of knots when modelling data<a class="anchor" aria-label="anchor" href="#choice-of-knots-when-modelling-data"></a>
</h2>
<p>By default, internal knots are placed at the quantiles of the vector
comprising the uncensored survival times in the individual level data,
using 10 basis functions, and the smoothed version of the basis. Users
can override these defaults however, and use any number of knots, placed
at any position.</p>
<p>In particular, the default is to place the highest knot at the
highest follow-up time in the data. This default should be overridden if
you want to extrapolate, and you think the hazard might change. A
sensible guide is to place the upper knot at the latest time that you
are interested in modelling. Beyond this time, you either think the
hazard will not change, or any changes in the hazard do not matter for
whatever purpose the model is used for.</p>
<p>With external data, it is advisable to place knots manually to cover
the time period of the data, the time period you want to estimate
survival over, and to enable variations over time in the hazard to be
estimated if the data allow this. Some examples are given in the <a href="https://chjackson.github.io/survextrap/articles/cetuximab.html">cetuximab
case study</a>.</p>
<p>The priors should then be chosen to give a low probability that the
hazard varies outside the range thought reasonable, e.g. in terms of
orders of magnitude. See the <a href="priors.html">priors vignette</a>
for detailed guidance on this.</p>
<p>The default number of knots does not depend on the absolute amount of
data. With small datasets, we will be relying more strongly on the prior
to do the smoothing. We could assess whether this matters by using
LOO-CV cross-validation.</p>
<p>With external data, we want a choice of knots outside the data which
we can defend as allowing a reasonable range of shapes for the hazard
function, prior to observing the data.</p>
</div>
<div class="section level2">
<h2 id="effect-of-covariates-on-the-hazard">Effect of covariates on the hazard<a class="anchor" aria-label="anchor" href="#effect-of-covariates-on-the-hazard"></a>
</h2>
<p>In <code>survextrap</code>, the hazard may also depend on a vector of
covariates <span class="math inline">\(\boldsymbol{x}\)</span> as well
as time <span class="math inline">\(t\)</span>, and we write the hazard
as <span class="math inline">\(h(t,\boldsymbol{x})\)</span>.</p>
<div class="section level3">
<h3 id="proportional-hazards-model">Proportional hazards model<a class="anchor" aria-label="anchor" href="#proportional-hazards-model"></a>
</h3>
<p>The default model fitted is a <em>proportional hazards model</em>,
where the scale parameter <span class="math inline">\(\eta(\boldsymbol{x})\)</span> is defined as a
log-linear function of a vector of covariates <span class="math inline">\(\boldsymbol{x}\)</span>.</p>
<p><span class="math display">\[ \eta(\boldsymbol{x}) =
\exp(\boldsymbol{\beta}^T \boldsymbol{x}) \]</span></p>
<p>In this model, the ratio between the hazards <span class="math inline">\(h(t,\boldsymbol{x})\)</span> at two different
values of <span class="math inline">\(\boldsymbol{x}\)</span> is
constant with respect to time <span class="math inline">\(t\)</span>.
The <em>hazard ratios</em> (i.e. between a value of 1 and 0 for each
<span class="math inline">\(\boldsymbol{x}\)</span>) are <span class="math inline">\(exp(\boldsymbol{\beta})\)</span>.</p>
</div>
<div class="section level3">
<h3 id="nonprop">Flexible, non-proportional hazards model<a class="anchor" aria-label="anchor" href="#nonprop"></a>
</h3>
<p>An alternative <em>non-proportional hazards</em> model is available.
This is achieved by also modelling the spline coefficients <span class="math inline">\(p_i\)</span> as functions of covariates, in
addition to the log-linear model on <span class="math inline">\(\eta\)</span>.</p>
<p><span class="math display">\[log(p_i(\boldsymbol{x}) /
p_1(\boldsymbol{x})) = \gamma_i(\boldsymbol{x)} \]</span></p>
<p><span class="math display">\[ \gamma_i(\boldsymbol{x)} \sim
Logistic(\mu_i + \boldsymbol{\delta}^T_i \boldsymbol{x}, \sigma) \quad
(i=2,...,n), \quad \delta_1 = 0 \]</span></p>
<p>The <span class="math inline">\(s\)</span>th element of the vector
<span class="math inline">\(\boldsymbol{\delta}_i\)</span> describes the
departure from proportional hazards for the <span class="math inline">\(s\mbox{th}\)</span> covariate in the region of
time associated with the <span class="math inline">\(i\)</span>th spline
basis term. With all <span class="math inline">\(\boldsymbol{\delta}_i =
0\)</span> the model will be the proportional hazards model.
Non-proportional hazards can be applied to any subset of the covariates
if needed, or all covariates.</p>
<p>For each covariate <span class="math inline">\(s\)</span>, a
hierarchical model is used for the non-proportionality effects <span class="math inline">\(\delta_{ks}\)</span>. This model “partially pools”
the effects from different regions of time <span class="math inline">\(i\)</span>, either via an exchangeable model,</p>
<p><span class="math display">\[ \delta_{is} \sim Normal(0, \tau_s^2)
\]</span></p>
<p>or a normal second-order random walk model, like the one used for the
basis coefficients. In the non-proportional hazards model, the ratio
between the hazards <span class="math inline">\(h(t,\boldsymbol{x})\)</span> at different
covariate values <span class="math inline">\(\boldsymbol{x}\)</span> is
a function of time <span class="math inline">\(t\)</span>. Since the
<span class="math inline">\(\boldsymbol{\delta}_i\)</span> may be
arbirtarily different in each region of time <span class="math inline">\(i\)</span>, the hazard ratio can be an
arbitrarily-flexible function of time. The amount and shape of
non-proportionality is estimated from the data, while the hierarchical
model protects against overfitting.</p>
</div>
</div>
<div class="section level2">
<h2 id="cure_methods">Cure models<a class="anchor" aria-label="anchor" href="#cure_methods"></a>
</h2>
<p>The <code>survextrap</code> package implements a mixture cure version
of the M-spline model.</p>
<p>In a mixture cure model, the survival is defined by <span class="math inline">\(S(t | p, \boldsymbol{\theta}) = p +
(1-p)S_0(t|\boldsymbol{\theta})\)</span>, where <span class="math inline">\(p\)</span> is sometimes termed the “cure
probability”, and <span class="math inline">\(S_0(t|\boldsymbol{\theta})\)</span> is a
parametric model with parameters <span class="math inline">\(\boldsymbol{\theta}\)</span>, termed the “uncured
survival”. In <code>survextrap</code>, <span class="math inline">\(S_0\)</span> is the M-spline model.</p>
<p>This model can be interpreted in two different ways:</p>
<ul>
<li><p>as a mixture model, where a person has hazard <span class="math inline">\(h_1(t)=0\)</span> at all times <span class="math inline">\(t\)</span> with probability <span class="math inline">\(p\)</span>, or hazard <span class="math inline">\(h_0(t)\)</span> at all times with probability
<span class="math inline">\(1-p\)</span>.</p></li>
<li><p>as a model where everyone follows the same hazard function <span class="math inline">\(h(t) = f(t)/S(t)\)</span>, where the PDF is <span class="math inline">\(f(t) = (1-p)f_0(t)\)</span>, and <span class="math inline">\(f_0(t)\)</span> is the PDF of the “uncured”
parametric model. Hence <span class="math inline">\(h(t) = f_0(t) /
(p/(1-p) + S_0(t))\)</span>, which asymptotically decreases towards zero
with increasing <span class="math inline">\(t\)</span> (as long as <span class="math inline">\(p&gt;0\)</span>).</p></li>
</ul>
<p>Since we cannot observe whether censored observations are part of the
“cured” subgroup, these interpretations are indistinguishable in
practice.</p>
</div>
<div class="section level2">
<h2 id="relsurv_methods">Relative survival / additive hazards models<a class="anchor" aria-label="anchor" href="#relsurv_methods"></a>
</h2>
<p><code>survextrap</code> also implements a model where the overall
hazard is assumed to be the sum of two components corresponding to
different causes of death. These are usually termed the “background”
hazard <span class="math inline">\(h_b(t)\)</span> and the
“cause-specific” or “excess” hazard <span class="math inline">\(h_c(t)\)</span>, so that <span class="math inline">\(h(t) = h_b(t) + h_c(t)\)</span>, where:</p>
<ul>
<li><p><span class="math inline">\(h_b(t)\)</span> is assumed to be a
known, piecewise-constant (step) function, and is provided by the user
in a data frame that gives the background hazard in each of a series of
time periods. See <a href="examples.html#relsurv_examples">the
examples</a>.</p></li>
<li><p><span class="math inline">\(h_c(t)\)</span> follows the standard
flexible parametric (M-spline) model used in
<code>survextrap</code>.</p></li>
</ul>
<p>This is known as a “relative survival” model, since the additive
model for the hazards implies a multiplicative model for survival: <span class="math inline">\(S(t) = S_b(t)S_c(t)\)</span>. This kind of model
is often used when the background hazard is confidently known (from
national statistics on general mortality) and the cause-specific hazard
can be inferred from the individual-level data.</p>
<p>The model used in <code>survextrap</code> is a variant of the model
by <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.3064" class="external-link">Nelson
et al</a> and should give similar results. The only difference is that
the model in <code>survextrap</code> is Bayesian, and a different kind
of spline is used.</p>
<div class="section level4">
<h4 id="combining-relative-survival-and-cure-models">Combining relative survival and cure models<a class="anchor" aria-label="anchor" href="#combining-relative-survival-and-cure-models"></a>
</h4>
<p>To use a cure model and a relative survival model together, <span class="math inline">\(h_c(t)\)</span> is defined by a mixture cure
version of the M-spline model, and a background hazard data set is
supplied to define <span class="math inline">\(h_b(t)\)</span>. This
allows the overall hazard <span class="math inline">\(h(t)\)</span> to
decrease asymptotically towards a background hazard <span class="math inline">\(h_b(t)\)</span>, instead of decreasing towards
zero.</p>
<p>This model is appropriate if we are sure that people with the disease
are eventually “cured”, or alternatively, their risk from the disease
becomes negligible compared to their risk of death from other causes,
and we have good information about general mortality and when this
starts to dominate. Therefore average survival is estimated by naturally
combining short-term information on disease-specific survival with
long-term data on general mortality.</p>
</div>
</div>
<div class="section level2">
<h2 id="waning">Treatment effect waning models<a class="anchor" aria-label="anchor" href="#waning"></a>
</h2>
<div class="section level4">
<h4 id="principles">Principles<a class="anchor" aria-label="anchor" href="#principles"></a>
</h4>
<p>Suppose we have short-term data, say from a trial of a treatment
against a control. The trial data is assumed to be representative of the
treatment effect in the short term. We may also have long-term data that
gives information about the survival in the control group. However we do
not believe that the effect of the treatment will continue. In the long
term, we suppose the treatment effect “wanes” or diminishes, so that
over time the treatment and control group will have similar risks.</p>
<p>How is this done in <code>survextrap</code>? Essentially:</p>
<ul>
<li><p>We fit a <code>survextrap</code> (M-spline) model that combines
the short-term data with the long-term data on the control group. From
this model, we estimate the short-term treatment effect (e.g. with a
proportional hazards model), and the long-term survival in the control
group.</p></li>
<li><p>However, we do not want to use the model directly to estimate
long-term survival in the treatment group, because it relies on the
assumption that the hazard ratio in the short term continues in the
longer term. Instead, to predict long-term survival in the <em>treatment
group</em> we assume that the treatment effect <em>wanes</em> over some
time interval from <span class="math inline">\(t_{min}\)</span> to <span class="math inline">\(t_{max}\)</span>, where <span class="math inline">\(t_{min}\)</span> is after the follow-up period of
the trial.</p></li>
</ul>
</div>
<div class="section level4">
<h4 id="waning-model-details">Waning model: details<a class="anchor" aria-label="anchor" href="#waning-model-details"></a>
</h4>
<p>Specifically, to predict the long-term hazard <span class="math inline">\(h(t | x=1)\)</span> in the treated group, we
assume:</p>
<ul>
<li><p>Between time <span class="math inline">\(t=0\)</span> and <span class="math inline">\(t=t_{min}\)</span>, <span class="math inline">\(h(t | x=1)\)</span> is equal to the hazard in the
treated group <span class="math inline">\(x=1\)</span>, estimated from
the model.</p></li>
<li><p>After time <span class="math inline">\(t=t_{max}\)</span>, <span class="math inline">\(h(t | x=1)\)</span> is equal to the hazard in the
control group <span class="math inline">\(h(t | x=0)\)</span>, estimated
from the model.</p></li>
<li>
<p>During the interval between <span class="math inline">\(t =
t_{min}\)</span> and <span class="math inline">\(t = t_{max}\)</span>,
the log hazard ratio <span class="math inline">\(\log(hr(t)) =
\log(h(t|x=1) | h(t|x=0))\)</span> diminishes linearly between the log
hazard ratio <span class="math inline">\(\log(hr(t_{min}))\)</span> at
<span class="math inline">\(t_{min}\)</span>, estimated from the model,
and zero at <span class="math inline">\(t_{max}\)</span>. That is, <span class="math inline">\(\log(hr(t)) = w \log(hr(t_{min}))\)</span>, where
<span class="math inline">\(w = (t - t_{min}) / (t_{max} -
t_{min})\)</span>.</p>
<p>Hence the predicted hazard for the treated group at <span class="math inline">\(t\)</span> is defined from the M-spline model as
<span class="math inline">\(h(t|x=1) = h(t | x=0) hr(t)\)</span>, where
<span class="math inline">\(h(t|x=0)\)</span> comes from the fitted
M-spline model.</p>
</li>
<li><p>A piecewise-constant approximation, on a fine grid, is then
imposed on the hazard within the waning period to allow easy calculation
of the cumulative hazard, survival and related quantities.</p></li>
</ul>
<p>Note that the waning assumption is implemented during
<em>prediction</em> from the fitted model, rather than as a “prior” or
structural assumption used during model fitting. The baseline log hazard
ratio at <span class="math inline">\(t_{min}\)</span> is inferred from
the M-spline model, short-term data and any long-term data provided.
Then when requesting predictions of, e.g., survival curves, hazard
curves or mean survival times from this fitted model, we can optionally
request that over some interval <span class="math inline">\(t_{min},t_{max}\)</span> the log hazard ratio for
some covariate changes linearly between the value estimated from the
model and some “null” value.</p>
<p>The fitted M-spline model does not necessarily need to be a
proportional hazards model to use treatment waning. If the fitted model
is non-proportional hazards, the hazard ratio will be non-constant
between time 0 and <span class="math inline">\(t_{min}\)</span>, then
wane between the value at <span class="math inline">\(t_{min}\)</span>
and zero at <span class="math inline">\(t_{max}\)</span>.</p>
</div>
<div class="section level4">
<h4 id="waning-models-example">Waning models: example<a class="anchor" aria-label="anchor" href="#waning-models-example"></a>
</h4>
<p>For clarity here, we subset the example data to only two out of the
three treatment groups: observation-only and levamisole.</p>
<p>First we fit a <code>survextrap</code> model (arbitrarily, for this
example, an M-spline model with 5 basis terms). See the <a href="examples.html">examples vignette</a> for more examples of calling
<code>survextrap</code> function.</p>
<p>We extrapolate the survival and hazard curves up to 10 years under a
naive assumption of proportional hazards beyond the end of follow-up (3
years).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="va">colons2</span> <span class="op">&lt;-</span> <span class="va">colons</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rx</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>, <span class="st">"Lev"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rxph_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons2</span>, </span>
<span>                       fit_method<span class="op">=</span><span class="st">"opt"</span>, mspline<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>To predict from this model under a waning treatment effect we must
define the following:</p>
<ul>
<li><p><code>wane_period</code>: a vector containing the start and end
of the period over which the effect wanes</p></li>
<li><p><code>newdata</code>: the covariate values that define the hazard
under the “full” effect (before waning starts)</p></li>
<li><p><code>newdata0</code>: the covariate values that define the
hazard under the “null” effect (after waning finishes)</p></li>
</ul>
<p>Optionally we can also supply <code>wane_nt</code>, which defines the
number of intervals to use for the grid approximation to the hazard
within the waning period. This defaults to 10, which I’d expect to be
sufficient in practice.</p>
<p>These things are supplied as arguments to the functions
<code>survival</code>, <code>hazard</code> and <code>rmst</code>, and
the <code>plot</code> and <code>mean</code> methods for survextrap
objects.</p>
<p>In this example, we predict the survival and hazard over 10 years for
the treated and control groups. The treated group is assumed to
experience treatment effect waning - so that between 5 and 10 years,
their log hazard changes linearly between the modelled hazard of the
treated group and the modelled hazard of the control group.</p>
<p>To obtain predictions for both groups, we first define the “full” and
“null” covariate values, as data frames with two rows, one for the
treated group and one for the control group. Note for the control group,
the “full” and “null” covariate values are the same.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lev"</span>,<span class="st">"Obs"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nd_null</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>,<span class="st">"Obs"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then supply these as arguments to the <code>plot</code> method,
along with a definition of the waning period (5 to 10 years), to
illustrate the survival and hazard trajectories for each group under
this waning model. Note how the hazard curves converge over the waning
period. The survival curves have only just started to converge - the
effects of the waning on survival would be more noticeable over longer
extrapolation periods (say 30-40 years).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, niter<span class="op">=</span><span class="fl">1000</span>, </span>
<span>     newdata <span class="op">=</span> <span class="va">nd_full</span>, newdata0 <span class="op">=</span> <span class="va">nd_null</span><span class="op">)</span></span></code></pre></div>
<p><img src="methods_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>We also compare the restricted mean survival times (up to 50 years)
with and without treatment waning. The consequence of the waning
treatment effect is to reduce this long term mean survival time under
the treated group by about three years. (Combining waning with
computation of the restricted mean is computationally intensive, so in
this illustration, we only use a sample of 20 from the posterior
distribution).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>digits<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fl">50</span>, niter<span class="op">=</span><span class="fl">100</span>, newdata<span class="op">=</span><span class="va">nd_full</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   variable rx        t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst     Lev      50   8.25  4.29  20.5</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst     Obs      50   4.95  3.06  12.3</span></span></code></pre>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fl">50</span>, niter<span class="op">=</span><span class="fl">20</span>, newdata<span class="op">=</span><span class="va">nd_full</span>, newdata0<span class="op">=</span><span class="va">nd_null</span>, wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   variable rx        t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst     Lev      50   7.22  4.34  22.0</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst     Obs      50   4.88  3.46  15.8</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="waning-models-distribution-utilities">Waning models: distribution utilities<a class="anchor" aria-label="anchor" href="#waning-models-distribution-utilities"></a>
</h4>
<p>Distribution and random number generation functions for the “waning
effect” model are available as <code><a href="../reference/Survmspline_wane.html">psurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">Hsurvmspline_wane()</a></code>, <code><a href="../reference/Survmspline_wane.html">hsurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">dsurvmspline_wane()</a></code>, <code><a href="../reference/Survmspline_wane.html">qsurvmspline_wane()</a></code>,
<code><a href="../reference/Survmspline_wane.html">rsurvmspline_wane()</a></code>, to enable users to construct other
summaries or predictions from this model.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
