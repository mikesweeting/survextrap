<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Case study of using survextrap: cetuximab for head and neck cancer • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Case study of using survextrap: cetuximab for head and neck cancer">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.15</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cetuximab.html">Case study of using survextrap: cetuximab for head and neck cancer</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
    <a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a>
    <a class="dropdown-item" href="../articles/sbc.html">Simulation-based calibration of survextrap</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Case study of using survextrap: cetuximab for head and neck cancer</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/cetuximab.Rmd" class="external-link"><code>vignettes/cetuximab.Rmd</code></a></small>
      <div class="d-none name"><code>cetuximab.Rmd</code></div>
    </div>

    
    
<p>This article is an in-depth demonstration of how
<code>survextrap</code> could be used in a realistic application to a
health technology evaluation. A range of data sources and analysis
choices are explored, and publication-style plots and tables are
produced.</p>
<p>A more formal account of this analysis is given in the <a href="https://doi.org/10.1186/s12874-023-02094-1" class="external-link">paper</a> about the
package and method. This article also serves the purpose of providing
the code that was used in the paper, making the analysis reproducible
and explaining how the code is used.</p>
<p>A more casual, quick tour of the package’s features is given in the
<code>survextrap</code> package vignette called <a href="examples.html">examples.html</a>, and the methods are explained in
detail in <a href="methods.html">methods.html</a>.</p>
<div class="section level2">
<h2 id="simple-data-summary">Simple data summary<a class="anchor" aria-label="anchor" href="#simple-data-summary"></a>
</h2>
<p>The data are from an analysis of survival in head and neck cancer,
previously conducted by <a href="https://journals.sagepub.com/doi/pdf/10.1177/0272989X16670604" class="external-link">Guyot
et al.</a>. The <code>survextrap</code> package provides the data as
<code>cetux</code>, <code>cetux_seer</code> and <code>cetux_bh</code>.
<code>cetux</code> is data from a clinical trial of cetuximab and
radiotherapy, compared to a control group who only received
radiotherapy. <code>cetux_seer</code> contain matched data from a USA
cancer registry, and <code>cetux_bh</code> describes comparable survival
for the general population of the USA. See <code><a href="../reference/cetux.html">help("cetux")</a></code>
and <a href="https://journals.sagepub.com/doi/pdf/10.1177/0272989X16670604" class="external-link">Guyot
et al.</a> for more information.</p>
<p>We first load the required packages, plot a Kaplan-Meier curve of the
individual trial data, and create subsets of the data by treatment
group, for use in some of the later analyses.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span> <span class="co"># for colour palettes</span></span>
<span><span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html" class="external-link">ggsurvplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years"</span><span class="op">)</span></span></code></pre></div>
<p><img src="cetuximab_files/figure-html/packages_data.png" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">control</span> <span class="op">&lt;-</span> <span class="va">cetux</span><span class="op">[</span><span class="va">cetux</span><span class="op">$</span><span class="va">treat</span><span class="op">==</span><span class="st">"Control"</span>,<span class="op">]</span></span>
<span><span class="va">cetuximab</span> <span class="op">&lt;-</span> <span class="va">cetux</span><span class="op">[</span><span class="va">cetux</span><span class="op">$</span><span class="va">treat</span><span class="op">==</span><span class="st">"Cetuximab"</span>,<span class="op">]</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="spline-specification">Spline specification<a class="anchor" aria-label="anchor" href="#spline-specification"></a>
</h2>
<p>First we set up an M-spline, specifying only that we expect a maximum
of 6 spline coefficients to be sufficient to describe hazard variations,
and we want to allow hazards to change up to 20 years. The resulting
default spline knots are saved in the <code>mspline</code> object here.
The default knots are based on quantiles of the event times in the data
(which is why we supply the data in this command).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_spec.html">mspline_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">cetux</span>, df<span class="op">=</span><span class="fl">6</span>, add_knots<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="choice-of-priors">Choice of priors<a class="anchor" aria-label="anchor" href="#choice-of-priors"></a>
</h2>
<p>For transparency here, all priors are specified explicitly, rather
than relying on the package defaults. The parameters of spline models
hard to interpret, but we can determine suitable priors by translating
them to quantities that are easier to interpret. This will sometimes
require simulation. Note also that knowledge of the spline knots is
necessary to do some of these calculations, which is why we set up the
<code>mspline</code> object in advance of setting up the priors. See the
linked function documentation for more details about how these functions
work.</p>
<div class="section level5">
<h5 id="hazard-scale-parameter-eta-">Hazard scale parameter <span class="math inline">\(\eta\)</span>.<a class="anchor" aria-label="anchor" href="#hazard-scale-parameter-eta-"></a>
</h5>
<p>Since patients in the trial have a median age of 57 (range 34 to 83),
the prior for <span class="math inline">\(\eta\)</span> is calibrated to
imply a prior mean survival of 25 years after diagnosis, but with a
variance chosen so that mean survival could be as high as 100 years
after diagnosis. The function <code><a href="../reference/p_meansurv.html">p_meansurv()</a></code> translates a
prior median and upper 95% credible limit for mean survival to an
appropriate normal distribution for the log hazard scale <span class="math inline">\(\eta\)</span>. Note that this distribution
represents uncertainty about the population mean, not individual
variability (which should be broader).</p>
<p>Conversely, the <code><a href="../reference/prior_haz_const.html">prior_haz_const()</a></code> function translates a
normal prior for <span class="math inline">\(\eta\)</span> to the
corresponding beliefs about survival. We use this to check that the
lower limit of the distribution derived by <code><a href="../reference/p_meansurv.html">p_meansurv()</a></code> is
sensible.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior_hscale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">25</span>, upper<span class="op">=</span><span class="fl">100</span>, mspline<span class="op">=</span><span class="va">mspline</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/prior_haz_const.html">prior_haz_const</a></span><span class="op">(</span><span class="va">mspline</span>, prior_hscale <span class="op">=</span> <span class="va">prior_hscale</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##        haz   mean</span></span>
<span><span class="co">## 2.5%  0.01   6.25</span></span>
<span><span class="co">## 50%   0.04  25.00</span></span>
<span><span class="co">## 97.5% 0.16 100.00</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="hazard-variability-parameter-sigma-">Hazard variability parameter <span class="math inline">\(\sigma\)</span>.<a class="anchor" aria-label="anchor" href="#hazard-variability-parameter-sigma-"></a>
</h5>
<p>The prior for <span class="math inline">\(\sigma\)</span> is chosen
so that the highest hazard values over the 20 year horizon (90%
quantile) are expected to be about <span class="math inline">\(\rho=2\)</span> times the lowest values (10%
quantile), but with a vague 95% credible interval for <span class="math inline">\(\rho\)</span> of between about 1 and 16. The
function <code><a href="../reference/prior_haz.html">prior_haz_sd()</a></code> uses simulation to estimate the
beliefs implied by a particular Gamma prior for <span class="math inline">\(\sigma\)</span> (jointly with the prior specified
for the hazard scale).</p>
<p>The choice of Gamma(2,5) here was arrived at through trial-and-error,
until the distribution for <span class="math inline">\(\rho\)</span>
(the quantity <code>hr</code> returned by <code><a href="../reference/prior_haz.html">prior_haz_sd()</a></code>)
matched our prior judgement. Note that repeated simulations will give
slightly different results unless the seed is set.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">prior_hsd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/prior_haz.html">prior_haz_sd</a></span><span class="op">(</span>mspline <span class="op">=</span> <span class="va">mspline</span>,</span>
<span>             prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span>,</span>
<span>             prior_hscale <span class="op">=</span> <span class="va">prior_hscale</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##             sd_haz    sd_mean        hr</span></span>
<span><span class="co">## 2.5%  0.0002520058   1.374872  1.060858</span></span>
<span><span class="co">## 50%   0.0036770673  17.146610  1.855044</span></span>
<span><span class="co">## 97.5% 0.0371823461 303.313735 15.759463</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="hazard-ratio-for-treatment-effects">Hazard ratio for treatment effects<a class="anchor" aria-label="anchor" href="#hazard-ratio-for-treatment-effects"></a>
</h5>
<p>The prior for the treatment effect is weak, and designed only to rule
out extremely implausible values, with a prior median of 1 and upper 95%
credible limit of 50 for the hazard ratio. The function
<code><a href="../reference/p_hr.html">p_hr()</a></code> translates this information to a normal prior for
the log hazard ratio. The function <code><a href="../reference/prior_hr.html">prior_hr()</a></code> goes in the
other direction, and summarises the prior for the hazard ratio implied
by a particular normal distribution on the log scale (in the special
format returned by <code><a href="../reference/p_hr.html">p_hr()</a></code>, or alternatively by the function
<code><a href="../reference/priors.html">p_normal()</a></code>).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior_loghr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/p_hr.html">p_hr</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/prior_hr.html">prior_hr</a></span><span class="op">(</span><span class="va">prior_loghr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  2.5%   50% 97.5% </span></span>
<span><span class="co">##  0.02  1.00 50.00</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="hazard-ratio-variability-parameter-tau-in-non-proportional-hazards-model">Hazard ratio variability parameter <span class="math inline">\(\tau\)</span> in non-proportional hazards
model<a class="anchor" aria-label="anchor" href="#hazard-ratio-variability-parameter-tau-in-non-proportional-hazards-model"></a>
</h5>
<p>In a similar way, we can calibrate the Gamma prior for the parameter
<span class="math inline">\(\tau\)</span>, which is only used in
non-proportional hazards models. This governs the size of departure from
proportional hazards, i.e. the variability in the hazard ratio over
time. <span class="math inline">\(\tau\)</span> itself does not have a
direct interpretation, but we can simulate hazard curves under different
treatment groups, and compute the ratio <span class="math inline">\(\rho\)</span> between the “highest” (90% quantile)
and “lowest” (10% quantile) hazard ratio over time. If hazards are
proportional, then <span class="math inline">\(\rho=1\)</span>.</p>
<p>Here a Gamma(2,3) prior is used, which represents a judgement that
the hazard ratio could vary about 10-fold (to an order of magnitude) at
different points over 20 years.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">prior_hrsd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/prior_haz.html">prior_hr_sd</a></span><span class="op">(</span>mspline <span class="op">=</span> <span class="va">mspline</span>,                              </span>
<span>            prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span>,</span>
<span>            prior_loghr <span class="op">=</span> <span class="va">prior_loghr</span>,</span>
<span>            prior_hscale <span class="op">=</span> <span class="va">prior_hscale</span>,</span>
<span>            prior_hrsd <span class="op">=</span> <span class="va">prior_hrsd</span>,</span>
<span>            formula <span class="op">=</span> <span class="op">~</span><span class="va">treat</span>,</span>
<span>            nonprop <span class="op">=</span> <span class="op">~</span><span class="va">treat</span>,</span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="fl">1</span><span class="op">)</span>, </span>
<span>            newdata0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              sd_hr      hrr</span></span>
<span><span class="co">## 2.5%   0.001349767 1.080091</span></span>
<span><span class="co">## 50%    0.115265023 1.620410</span></span>
<span><span class="co">## 97.5% 26.188560197 6.940072</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="notes-on-model-computation">Notes on model computation<a class="anchor" aria-label="anchor" href="#notes-on-model-computation"></a>
</h2>
<p>By default, <code>survextrap</code> fits models by MCMC sampling.
This can be slow, and with the default settings takes 2 minutes per run.
For model development, we can reduce the number of MCMC chains and
iterations by setting <code>chains</code> and <code>iter</code> when
calling <code>survextrap</code>. These default to 4 and 2000
respectively in the <code>rstan</code> package that
<code>survextrap</code> uses for computation.</p>
<p>An approximation to full MCMC sampling can also be specified by
calling <code>survextrap</code> with <code>fit_method="opt"</code>: this
runs instantly and obtains the posterior mode exactly, but crudely
approximates other posterior summaries. This is very useful for
development.</p>
<p>When we are ready to produce the “final” results, we can switch back
to MCMC with the default number of chains and iterations.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>mc.cores <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># CRAN check limits to 2 cores</span></span>
<span><span class="co"># options(mc.cores = parallel::detectCores())</span></span>
<span><span class="va">chains</span> <span class="op">&lt;-</span> <span class="fl">4</span>; <span class="va">iter</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span></code></pre></div>
<p>The <code>rhat</code> convergence diagnostic shown when printing the
results of a <code>survextrap</code> fit should be checked - this should
be close to 1 if the MCMC fit has converged.</p>
<p>Occasionally the fitting may report “divergent transitions”. This is
a limitation of the sampling algorithm, and can happen when the
posterior distribution is awkward to sample from. See the <a href="https://mc-stan.org/misc/warnings.html" class="external-link">Stan documentation</a> for
technical details. If there are only one or two divergent transitions,
the message is probably safe to ignore, but in any case the results
should be examined to ensure that they make sense. With lots of
divergent transitions, it is safer to simplify the model, e.g. by using
stronger priors or fewer spline knots.</p>
</div>
<div class="section level2">
<h2 id="models-for-the-trial-data-alone">Models for the trial data alone<a class="anchor" aria-label="anchor" href="#models-for-the-trial-data-alone"></a>
</h2>
<div class="section level3">
<h3 id="single-treatment-group">Single treatment group<a class="anchor" aria-label="anchor" href="#single-treatment-group"></a>
</h3>
<p>First we fit two models for the control group trial data: one
(<code>mod_con</code>) allowing hazard variations up to 20 years, and
another (<code>mod_con5</code>) assuming a constant hazard after 5
years. <code>mod_con5</code> is implemented by leaving out the
<code>mspline</code> argument to <code>survextrap</code>, in which case
the final spline knot is set to the end of the data. All models in
<code>survextrap</code> assume a constant hazard after the final spline
knot.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline<span class="op">=</span><span class="va">mspline</span>,</span>
<span>                      chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                      prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span>
<span><span class="va">mod_con5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, </span>
<span>                       chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                       prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<p>A plot comparing the survival and hazard curves from these models is
then built. We use the <code><a href="../reference/survival.html">survival()</a></code> and <code><a href="../reference/hazard.html">hazard()</a></code>
functions to extract survival and hazard estimates, and combine these to
give a dataset that can be plotted with <code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_con5</span>, tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"Constant hazard"</span><span class="op">)</span></span>
<span><span class="va">surv_ipd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_con</span>, tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"Varying hazard"</span><span class="op">)</span></span>
<span><span class="va">surv_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">surv_const</span>, <span class="va">surv_ipd</span><span class="op">)</span></span>
<span><span class="va">haz_const</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_con5</span>, tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"Constant hazard"</span><span class="op">)</span></span>
<span><span class="va">haz_ipd</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_con</span>, tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="st">"Varying hazard"</span><span class="op">)</span></span>
<span><span class="va">haz_single</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">haz_const</span>, <span class="va">haz_ipd</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">surv_single</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, </span>
<span>                        group<span class="op">=</span><span class="va">model</span>, col<span class="op">=</span><span class="va">model</span>, fill<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, colour<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mod_con</span><span class="op">$</span><span class="va">km</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">surv</span><span class="op">)</span>, lwd<span class="op">=</span><span class="fl">1.3</span>,</span>
<span>              inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Survival probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NULL</span>, fill<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">control</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">mod_con5</span><span class="op">$</span><span class="va">mspline</span><span class="op">$</span><span class="va">iknots</span>, col<span class="op">=</span><span class="st">"gray80"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: A numeric `legend.position` argument in `theme()` was deprecated in ggplot2</span></span>
<span><span class="co">## 3.5.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use the `legend.position.inside` argument of `theme()` instead.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ph</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_single</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, </span>
<span>                        group<span class="op">=</span><span class="va">model</span>, col<span class="op">=</span><span class="va">model</span>, fill<span class="op">=</span><span class="va">model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, colour<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.3</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">control</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">mod_con5</span><span class="op">$</span><span class="va">mspline</span><span class="op">$</span><span class="va">iknots</span>, col<span class="op">=</span><span class="st">"gray80"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html" class="external-link">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">grid</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/grid/grid.draw.html" class="external-link">grid.draw</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplotGrob.html" class="external-link">ggplotGrob</a></span><span class="op">(</span><span class="va">ps</span><span class="op">)</span>, </span>
<span>                      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplotGrob.html" class="external-link">ggplotGrob</a></span><span class="op">(</span><span class="va">ph</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="cetuximab_files/figure-html/fig_control.png" style="display: block; margin: auto;"></p>
<p>The plots show the posterior median and 95% credible intervals. There
are no data between 5 and 20 years, so the extrapolation of the trial
data over this period depends on the model assumption - either that the
hazard is constant, or that the hazard will change smoothly, but with an
unknown direction and extent of change. If we allow it to change, the
uncertainty is appropriately greater.</p>
</div>
<div class="section level3">
<h3 id="determining-an-optimal-number-of-knots">Determining an optimal number of knots<a class="anchor" aria-label="anchor" href="#determining-an-optimal-number-of-knots"></a>
</h3>
<p>The model seems to fit the trial data well, and the Bayesian
procedure is designed to mitigate against overfitting from having too
many spline knots. Even so, we might still want reassurance that the
spline function has an appropriate amount of complexity to describe the
data. Therefore we use LOOIC to compare a range of models with different
numbers of spline basis functions (set via the <code>df</code> argument
to <code>mspline_spec</code>).</p>
<details><div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dfs</span> <span class="op">&lt;-</span> <span class="fl">5</span><span class="op">:</span><span class="fl">12</span></span>
<span><span class="va">rescomp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dfs</span><span class="op">)</span>, ncol<span class="op">=</span><span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">dfs</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">msp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_spec.html">mspline_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, df<span class="op">=</span><span class="va">dfs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline<span class="op">=</span><span class="va">msp</span>,</span>
<span>                      chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                      prior_hscale <span class="op">=</span> <span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span> </span>
<span>    <span class="va">rescompi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>df <span class="op">=</span> <span class="va">dfs</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>looic <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"looic"</span>,<span class="st">"Estimate"</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod</span>,t<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">rescomp</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rescompi</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rescomp</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">rescompi</span><span class="op">)</span></span>
<span><span class="va">rescomp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>looic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">looic</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>         rmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s, %s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">median</span>,<span class="fl">2</span><span class="op">)</span>, </span>
<span>                       <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`lower`</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`upper`</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">looic</span>, <span class="va">rmf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>col.names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"df"</span>, <span class="st">"LOOIC"</span>, <span class="st">"Restricted mean survival (5 years)"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="right">df</th>
<th align="right">LOOIC</th>
<th align="left">Restricted mean survival (5 years)</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">5</td>
<td align="right">596.5</td>
<td align="left">2.88 (2.62, 3.13)</td>
</tr>
<tr class="even">
<td align="right">6</td>
<td align="right">597.4</td>
<td align="left">2.88 (2.62, 3.14)</td>
</tr>
<tr class="odd">
<td align="right">7</td>
<td align="right">590.8</td>
<td align="left">2.87 (2.6, 3.14)</td>
</tr>
<tr class="even">
<td align="right">8</td>
<td align="right">591.7</td>
<td align="left">2.88 (2.62, 3.13)</td>
</tr>
<tr class="odd">
<td align="right">9</td>
<td align="right">593.8</td>
<td align="left">2.88 (2.62, 3.13)</td>
</tr>
<tr class="even">
<td align="right">10</td>
<td align="right">594.1</td>
<td align="left">2.88 (2.62, 3.13)</td>
</tr>
<tr class="odd">
<td align="right">11</td>
<td align="right">592.6</td>
<td align="left">2.89 (2.62, 3.15)</td>
</tr>
<tr class="even">
<td align="right">12</td>
<td align="right">592.6</td>
<td align="left">2.89 (2.61, 3.15)</td>
</tr>
</tbody>
</table></details><p>The estimates of RMST within 5 years do not change within 0.1. Note
this is only one of many ad-hoc checks we could do - note we did not
change the prior for the smoothness <code>prior_hsd</code>, which also
governs the amount of smoothness of the hazard function. LOOCV is also
lower for <code>df=7</code>. In practice we might want to switch the
<code>df</code> according to what data are included, but for simplicity
of illustration in this article, we stick with <code>df=6</code> for all
models, which in general gives slightly stabler computation without
affecting the results.</p>
<p>Using LOOIC for model choice may result in fitted hazard functions
that wiggle a lot over time and appear to “overfit” the data - but this
may not matter if we just want to use the model for estimating
quantities averaged over time, such as restricted mean survival. LOOIC
is designed for <em>prediction</em>. If instead we want to use it for
<em>description</em> of the hazard trajectory, we might want to pick a
simpler model by setting <code>df</code> to a lower value.</p>
</div>
<div class="section level3">
<h3 id="models-for-the-trial-data-with-a-treatment-effect">Models for the trial data with a treatment effect<a class="anchor" aria-label="anchor" href="#models-for-the-trial-data-with-a-treatment-effect"></a>
</h3>
<p>We now fit a joint model for both arms of the trial data, describing
the treatment effect either through proportional hazards
(<code>mod_ph</code>) or with <code>survextrap</code>’s novel flexible
non-proportional hazards model (<code>mod_nph</code>).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_ph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span>, </span>
<span>                     mspline<span class="op">=</span><span class="va">mspline</span>, </span>
<span>                     chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                     prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span>,</span>
<span>                     prior_loghr<span class="op">=</span><span class="va">prior_loghr</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There were 3 divergent transitions after warmup. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">## to find out why this is a problem and how to eliminate them.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_nph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span>, mspline<span class="op">=</span><span class="va">mspline</span>, </span>
<span>                      chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                      nonprop <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                      prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span>,</span>
<span>                      prior_loghr<span class="op">=</span><span class="va">prior_loghr</span>, prior_hrsd<span class="op">=</span><span class="va">prior_hrsd</span><span class="op">)</span></span></code></pre></div>
<p>We also fit a model for the cetuximab treatment arm alone, to couple
with the model <code>mod_con</code> for the control arm that we fitted
earlier.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_cet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">cetuximab</span>, mspline<span class="op">=</span><span class="va">mspline</span>, </span>
<span>                      chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                      prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There were 1 divergent transitions after warmup. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">## to find out why this is a problem and how to eliminate them.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre>
<p>The survival curves for these three models are now compared.</p>
<details><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_ph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_ph</span>, tmax<span class="op">=</span><span class="fl">7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Proportional hazards"</span><span class="op">)</span></span>
<span><span class="va">surv_nph</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_nph</span>, tmax<span class="op">=</span><span class="fl">7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Non-proportional hazards"</span><span class="op">)</span></span>
<span><span class="va">surv_cet</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_cet</span>, tmax<span class="op">=</span><span class="fl">7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Separate fits"</span>, treat<span class="op">=</span><span class="st">"Cetuximab"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span></span>
<span><span class="va">surv_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_con</span>, tmax<span class="op">=</span><span class="fl">7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Separate fits"</span>, treat<span class="op">=</span><span class="st">"Control"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">treat</span><span class="op">)</span></span>
<span><span class="va">surv_trt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">surv_ph</span>, <span class="va">surv_nph</span>, <span class="va">surv_cet</span>, <span class="va">surv_con</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">surv_trt</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, col<span class="op">=</span><span class="va">Model</span>, lty<span class="op">=</span><span class="va">treat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">mod_ph</span><span class="op">$</span><span class="va">km</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">surv</span>, lty<span class="op">=</span><span class="va">treat</span><span class="op">)</span>, lwd<span class="op">=</span><span class="fl">1.3</span>,</span>
<span>              inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>lwd<span class="op">=</span><span class="fl">1.1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>lty<span class="op">=</span><span class="st">"Treatment"</span>, col<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Survival probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cetux</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="va">mod_con5</span><span class="op">$</span><span class="va">mspline</span><span class="op">$</span><span class="va">iknots</span>, col<span class="op">=</span><span class="st">"gray80"</span>, lty<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<img src="cetuximab_files/figure-html/fig_trt.png" style="display: block; margin: auto;"></details><p>The results and goodness-of fit are compared between these three
models. We compare estimates of restricted mean survival for the control
group (<code><a href="../reference/rmst.html">rmst()</a></code>), and the increase in mean survival time for
the treated group (<code><a href="../reference/irmst.html">irmst()</a></code> ). Both of these are restricted
to the 5-year trial horizon (<code>t=5</code>).</p>
<p>Note that when using functions like <code><a href="../reference/rmst.html">rmst()</a></code> or
<code><a href="../reference/survival.html">survival()</a></code> which extract outputs from models with
covariates, we supply <code>newdata</code> to say what covariate values
we want the outputs to be computed for. In the call to
<code><a href="../reference/rmst.html">rmst()</a></code> we told it to compute for the control group. We left
out <code>newdata</code> in the call to <code><a href="../reference/irmst.html">irmst()</a></code> because,
for models with one factor covariate with two levels, it will calculate,
by default, the mean for the second level minus the mean for the first
level.</p>
<details><div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comp_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">rm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod</span>, niter<span class="op">=</span><span class="fl">1000</span>, newdata<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="st">"Control"</span><span class="op">)</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>rm_med<span class="op">=</span><span class="st">"median"</span>, rm_lower<span class="op">=</span><span class="st">"lower"</span>, rm_upper<span class="op">=</span><span class="st">"upper"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">rm_med</span>, <span class="va">rm_lower</span>, <span class="va">rm_upper</span><span class="op">)</span></span>
<span>    <span class="va">irm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/irmst.html">irmst</a></span><span class="op">(</span><span class="va">mod</span>, niter<span class="op">=</span><span class="fl">1000</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>ir_med<span class="op">=</span><span class="st">"median"</span>, ir_lower<span class="op">=</span><span class="st">"lower"</span>, ir_upper<span class="op">=</span><span class="st">"upper"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">ir_med</span>, <span class="va">ir_lower</span>, <span class="va">ir_upper</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span>, <span class="va">rm</span>, <span class="va">irm</span>, </span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>looic <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"looic"</span>,<span class="st">"Estimate"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">rmst_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_con</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>rm_med<span class="op">=</span><span class="st">"median"</span>, rm_lower<span class="op">=</span><span class="st">"lower"</span>, rm_upper<span class="op">=</span><span class="st">"upper"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">rm_med</span>, <span class="va">rm_lower</span>, <span class="va">rm_upper</span><span class="op">)</span></span>
<span></span>
<span><span class="va">irmst_sep</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_cet</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">20</span><span class="op">)</span>, sample<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_con</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">20</span><span class="op">)</span>, sample<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">irmst_sep</span> <span class="op">&lt;-</span> <span class="va">irmst_sep</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">posterior</span><span class="fu">::</span><span class="fu"><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">summarise_draws</a></span><span class="op">(</span><span class="va">median</span>,</span>
<span>                             <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>t<span class="op">=</span><span class="va">variable</span>, ir_med<span class="op">=</span><span class="st">"median"</span>,ir_lower<span class="op">=</span><span class="st">"2.5%"</span>, ir_upper<span class="op">=</span><span class="st">"97.5%"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">ir_med</span>, <span class="va">ir_lower</span>, <span class="va">ir_upper</span><span class="op">)</span></span>
<span></span>
<span><span class="va">loo_sep</span> <span class="op">&lt;-</span> <span class="va">mod_con</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"looic"</span>,<span class="st">"Estimate"</span><span class="op">]</span> <span class="op">+</span></span>
<span>  <span class="va">mod_cet</span><span class="op">$</span><span class="va">loo</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"looic"</span>,<span class="st">"Estimate"</span><span class="op">]</span></span>
<span><span class="va">comp_sep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name<span class="op">=</span><span class="st">"mod_sep"</span><span class="op">)</span>, <span class="va">rmst_con</span>, <span class="va">irmst_sep</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>looic<span class="op">=</span><span class="va">loo_sep</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">trtcomp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu">comp_fn</span><span class="op">(</span><span class="va">mod_ph</span><span class="op">)</span>, <span class="fu">comp_fn</span><span class="op">(</span><span class="va">mod_nph</span><span class="op">)</span>, <span class="va">comp_sep</span><span class="op">)</span></span>
<span><span class="va">trtcompf</span> <span class="op">&lt;-</span> <span class="va">trtcomp</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s,%s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm_med</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm_lower</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm_upper</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         ir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s,%s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ir_med</span>,<span class="fl">2</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ir_lower</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">ir_upper</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>         looic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">looic</span><span class="op">)</span>,</span>
<span>         model <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_recode.html" class="external-link">fct_recode</a></span><span class="op">(</span><span class="va">name</span>, </span>
<span>                                     <span class="st">"(2a) Proportional hazards"</span><span class="op">=</span><span class="st">"mod_ph"</span>,</span>
<span>                                     <span class="st">"(2b) Non-proportional hazards"</span><span class="op">=</span><span class="st">"mod_nph"</span>,</span>
<span>                                     <span class="st">"(2c) Separate arms"</span><span class="op">=</span><span class="st">"mod_sep"</span></span>
<span>         <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">t</span>, <span class="va">rm</span>, <span class="va">ir</span>, <span class="va">looic</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">remove_rownames</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">trtcompf</span>, col.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Model"</span>,<span class="st">"Time horizon"</span>,</span>
<span>                                   <span class="st">"Restricted mean survival"</span>,</span>
<span>                                   <span class="st">"Increase in restricted mean survival"</span>,</span>
<span>                                   <span class="st">"LOOIC"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="27%">
<col width="11%">
<col width="22%">
<col width="33%">
<col width="5%">
</colgroup>
<thead><tr class="header">
<th align="left">Model</th>
<th align="right">Time horizon</th>
<th align="left">Restricted mean survival</th>
<th align="left">Increase in restricted mean survival</th>
<th align="right">LOOIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(2a) Proportional hazards</td>
<td align="right">5</td>
<td align="left">2.89 (2.64,3.12)</td>
<td align="left">0.31 (-0.03,0.62)</td>
<td align="right">1156</td>
</tr>
<tr class="even">
<td align="left">(2b) Non-proportional hazards</td>
<td align="right">5</td>
<td align="left">2.88 (2.62,3.15)</td>
<td align="left">0.31 (-0.05,0.67)</td>
<td align="right">1158</td>
</tr>
<tr class="odd">
<td align="left">(2c) Separate arms</td>
<td align="right">5</td>
<td align="left">2.88 (2.63,3.14)</td>
<td align="left">0.49 (-0.84,3.64)</td>
<td align="right">1161</td>
</tr>
<tr class="even">
<td align="left">(2a) Proportional hazards</td>
<td align="right">20</td>
<td align="left">4.89 (3.79,6.79)</td>
<td align="left">1.1 (-0.13,2.47)</td>
<td align="right">1156</td>
</tr>
<tr class="odd">
<td align="left">(2b) Non-proportional hazards</td>
<td align="right">20</td>
<td align="left">4.97 (3.8,7.03)</td>
<td align="left">1.13 (-0.47,3.04)</td>
<td align="right">1158</td>
</tr>
<tr class="even">
<td align="left">(2c) Separate arms</td>
<td align="right">20</td>
<td align="left">5.11 (3.83,7.28)</td>
<td align="left">0.49 (-0.84,3.64)</td>
<td align="right">1161</td>
</tr>
</tbody>
</table></details><p>There is very little difference between the fit of the three
models.</p>
<p>The following code formats the table in LaTeX format (for the
paper).</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">trtcompf</span>, sep<span class="op">=</span><span class="st">"  &amp;  "</span>, eol<span class="op">=</span><span class="st">"\\\\\n"</span>, quote<span class="op">=</span><span class="cn">FALSE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## model  &amp;  t  &amp;  rm  &amp;  ir  &amp;  looic\\</span></span>
<span><span class="co">## (2a) Proportional hazards  &amp;  5  &amp;  2.89 (2.64,3.12)  &amp;  0.31 (-0.03,0.62)  &amp;  1156\\</span></span>
<span><span class="co">## (2b) Non-proportional hazards  &amp;  5  &amp;  2.88 (2.62,3.15)  &amp;  0.31 (-0.05,0.67)  &amp;  1158\\</span></span>
<span><span class="co">## (2c) Separate arms  &amp;  5  &amp;  2.88 (2.63,3.14)  &amp;  0.49 (-0.84,3.64)  &amp;  1161\\</span></span>
<span><span class="co">## (2a) Proportional hazards  &amp;  20  &amp;  4.89 (3.79,6.79)  &amp;  1.1 (-0.13,2.47)  &amp;  1156\\</span></span>
<span><span class="co">## (2b) Non-proportional hazards  &amp;  20  &amp;  4.97 (3.8,7.03)  &amp;  1.13 (-0.47,3.04)  &amp;  1158\\</span></span>
<span><span class="co">## (2c) Separate arms  &amp;  20  &amp;  5.11 (3.83,7.28)  &amp;  0.49 (-0.84,3.64)  &amp;  1161\\</span></span></code></pre>
</div>
</div>
<div class="section level2">
<h2 id="external-data-registry-data-on-control-group">External data: registry data on control group<a class="anchor" aria-label="anchor" href="#external-data-registry-data-on-control-group"></a>
</h2>
<p>In this example, there are registry data giving counts of <span class="math inline">\(r_j\)</span> survivors to the next year out of
<span class="math inline">\(n_j\)</span> alive at year <span class="math inline">\(j\)</span>, from from <span class="math inline">\(j=5\)</span> years onwards. This is supplied in
the <code>survextrap</code> package as <code>cetux_seer</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cetux_seer</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   start stop   r   n   treat        haz haz_upper  haz_lower</span></span>
<span><span class="co">## 1     5    6 325 358 Control 0.09670780 0.1325969 0.06665828</span></span>
<span><span class="co">## 2     6    7 285 308 Control 0.07761060 0.1125955 0.04927675</span></span>
<span><span class="co">## 3     7    8 198 221 Control 0.10989567 0.1595617 0.06981746</span></span>
<span><span class="co">## 4     8    9 143 167 Control 0.15514918 0.2239099 0.09969098</span></span>
<span><span class="co">## 5     9   10 122 133 Control 0.08632808 0.1449198 0.04325704</span></span>
<span><span class="co">## 6    10   11 105 117 Control 0.10821358 0.1783369 0.05615430</span></span></code></pre>
<p>This data can be illustrated as annual hazard estimates, calculated
as <span class="math inline">\(-\log(r_j/n_j)\)</span>, shown as the
thin step function in the plot below.</p>
<p>We fit a model which assumes that people in the registry data have
the same survival as the control group in the trial. To allow for
potential variations in the hazard shape between each of the years from
6 to 25 for which registry data are reported, we add extra knots at 10,
15 and 20 years.</p>
<blockquote>
<p><strong>Note</strong>: if instead there had been only one row in the
external data, giving survivors to 25 years from those alive at 6 years,
it would be impossible to identify variations in the hazard
<em>within</em> the period from 6 to 25 years, so using multiple knots
inside this period would be futile.</p>
</blockquote>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspline_seer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_spec.html">mspline_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">cetux</span>, df<span class="op">=</span><span class="fl">6</span>, </span>
<span>                             add_knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">15</span>,<span class="fl">20</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mod_seer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, </span>
<span>                       external<span class="op">=</span><span class="va">cetux_seer</span>, mspline<span class="op">=</span><span class="va">mspline_seer</span>, </span>
<span>                       chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                       prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There were 1 divergent transitions after warmup. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">## to find out why this is a problem and how to eliminate them.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre>
<p>The results are illustrated, and compared to the model
<code>mod_con</code> for the trial data alone that allowed the hazard to
change after the trial. The registry data makes the hazard
extrapolations much more confident.</p>
<details><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">haz_con</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_con</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"No external data"</span><span class="op">)</span></span>
<span><span class="va">haz_seer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_seer</span>,tmax<span class="op">=</span><span class="fl">30</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"With registry data"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">haz_plot_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">haz_con</span>, <span class="va">haz_seer</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">t</span> <span class="op">&lt;</span> <span class="fl">26</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_plot_reg</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, col<span class="op">=</span><span class="va">Model</span>, fill<span class="op">=</span><span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, colour<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray30"</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_lower</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray70"</span>, lty<span class="op">=</span><span class="fl">2</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_upper</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray70"</span>, lty<span class="op">=</span><span class="fl">2</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">control</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.9</span><span class="op">)</span>, </span>
<span>          legend.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NULL</span>, fill<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<img src="cetuximab_files/figure-html/fig_registry.png" style="display: block; margin: auto;"></details><div class="section level3">
<h3 id="knot-selection-for-external-data">Knot selection for external data<a class="anchor" aria-label="anchor" href="#knot-selection-for-external-data"></a>
</h3>
<p>The hazard seems to fit the external data, even with just one knot
designed to capture hazard trajectory changes after the trial, placed at
20 years. For some reassurance, we examine some alternative knot
specifications, to ensure that we have captured all variations that we
need in order to estimate survival up to 20 years.</p>
<p>Placing knots at 10,15 and 20 years gives the lowest (best) LOOIC
from these alternatives. Adding more knots is judged to be over-fitting,
which hampers predictive ability, and fewer knots do not represent all
hazard variations. The changes in the RMST estimates between these
models are small though.</p>
<details><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">knot_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>,<span class="fl">20</span><span class="op">)</span>, </span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">8</span>,<span class="fl">20</span>,by<span class="op">=</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comp_fn</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">rm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod</span>, niter<span class="op">=</span><span class="fl">1000</span>, newdata<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="st">"Control"</span><span class="op">)</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>rm_med<span class="op">=</span><span class="st">"median"</span>,rm_lower<span class="op">=</span><span class="st">"lower"</span>, rm_upper<span class="op">=</span><span class="st">"upper"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s, %s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm_med</span>,<span class="fl">2</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm_lower</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm_upper</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">rmf</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">substitute</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span>, <span class="va">rm</span>,  </span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>looic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">loo_external</span><span class="op">$</span><span class="va">estimates</span><span class="op">[</span><span class="st">"looic"</span>,<span class="st">"Estimate"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="fl">3</span>, mode<span class="op">=</span><span class="st">"list"</span><span class="op">)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">mspex</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_spec.html">mspline_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span>, df<span class="op">=</span><span class="fl">6</span>, </span>
<span>                         add_knots <span class="op">=</span> <span class="va">knot_list</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, </span>
<span>                    external<span class="op">=</span><span class="va">cetux_seer</span>, mspline<span class="op">=</span><span class="va">mspex</span>, </span>
<span>                    chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                    prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span>
<span>  <span class="va">res</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">comp_fn</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: There were 6 divergent transitions after warmup. See</span></span>
<span><span class="co">## https://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup</span></span>
<span><span class="co">## to find out why this is a problem and how to eliminate them.</span></span></code></pre>
<pre><code><span><span class="co">## Warning: Examine the pairs() plot to diagnose sampling problems</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu">comp_fn</span><span class="op">(</span><span class="va">mod_seer</span><span class="op">)</span><span class="op">)</span>, <span class="va">res</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>knots <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"10,15,20"</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">knot_list</span>, <span class="va">paste</span>, collapse<span class="op">=</span><span class="st">","</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">knots</span>, <span class="va">rmf</span>, <span class="va">looic</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span>col.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Additional knots"</span>,</span>
<span>                           <span class="st">"Restricted mean survival over 20 years"</span>,<span class="st">"LOOIC"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Additional knots</th>
<th align="left">Restricted mean survival over 20 years</th>
<th align="right">LOOIC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">10,15,20</td>
<td align="left">5.8 (5.03, 6.63)</td>
<td align="right">1485</td>
</tr>
<tr class="even">
<td align="left">10,20</td>
<td align="left">5.74 (4.95, 6.55)</td>
<td align="right">1507</td>
</tr>
<tr class="odd">
<td align="left">20</td>
<td align="left">5.76 (5.05, 6.56)</td>
<td align="right">1514</td>
</tr>
<tr class="even">
<td align="left">8,10,12,14,16,18,20</td>
<td align="left">5.79 (5.06, 6.6)</td>
<td align="right">1508</td>
</tr>
</tbody>
</table></details>
</div>
</div>
<div class="section level2">
<h2 id="population-data-in-an-additive-hazards-model">Population data in an additive hazards model<a class="anchor" aria-label="anchor" href="#population-data-in-an-additive-hazards-model"></a>
</h2>
<p>An alternative way of including external data is through additive
hazards (or relative survival), using the <code>backhaz</code> argument
to supply a data frame that describes the background hazard at all
times. This describes the population of the USA but matched to the trial
patients by age, sex and calendar year, and is supplied in the
<code>survextrap</code> package as <code>cetux_bh</code>.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">cetux_bh</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   time    hazard</span></span>
<span><span class="co">## 1    0 0.0092656</span></span>
<span><span class="co">## 2    1 0.0101710</span></span>
<span><span class="co">## 3    2 0.0111254</span></span>
<span><span class="co">## 4    3 0.0117602</span></span>
<span><span class="co">## 5    4 0.0132862</span></span>
<span><span class="co">## 6    5 0.0144244</span></span></code></pre>
<p>The remaining data (trial and registry) are used to infer the excess
hazard for head and neck cancer patients. A model is fitted which
assumes the overall hazard for the trial and registry patients is the
sum of the background hazard (fixed from the data in
<code>backhaz</code>) and an unknown excess hazard to be estimated.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_seer_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline <span class="op">=</span> <span class="va">mspline_seer</span>,</span>
<span>                           external<span class="op">=</span><span class="va">cetux_seer</span>, backhaz<span class="op">=</span><span class="va">cetux_bh</span>, </span>
<span>                           chains<span class="op">=</span><span class="va">chains</span>,iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                           prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<details><div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">haz_seer</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_seer</span>,tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Without population data"</span><span class="op">)</span></span>
<span><span class="va">haz_seer_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_seer_pop</span>,tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"With population data"</span><span class="op">)</span></span>
<span><span class="va">haz_plot_reg_pop20</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">haz_seer</span>, <span class="va">haz_seer_pop</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_plot_reg_pop20</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, col<span class="op">=</span><span class="va">Model</span>, fill<span class="op">=</span><span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, colour<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">stop</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">stop</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_lower</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray60"</span>, lty<span class="op">=</span><span class="fl">2</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">stop</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_upper</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray60"</span>, lty<span class="op">=</span><span class="fl">2</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_bh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;</span> <span class="fl">20</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">hazard</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, colour<span class="op">=</span><span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">10</span>, y<span class="op">=</span><span class="fl">0</span>, label<span class="op">=</span><span class="st">"Population mortality"</span>, colour<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">control</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.8</span>, <span class="fl">0.9</span><span class="op">)</span>, </span>
<span>          legend.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NULL</span>, fill<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<img src="cetuximab_files/figure-html/fig_registry_pop20.png" style="display: block; margin: auto;"></details><p>Including the population data does not make much difference to the
estimated hazards over 20 years after diagnosis.</p>
<p>The benefit of the population data in this example is to inform
extrapolations over a longer time horizon than the 25 year horizon of
the registry data. We now consider extrapolations up to 40 years. To
allow the hazard shape to change up to 40 years, we extend the spline
specification to include two further knots at 30 and 40 years, in
addition to the ones already placed at 10, 15 and 20 years.</p>
<p>Two models are then fitted, to show the impact of the population
data. The first includes the trial and registry data.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mspline40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mspline_spec.html">mspline_spec</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span>, df<span class="op">=</span><span class="fl">6</span>, </span>
<span>                          add_knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">30</span>, <span class="fl">40</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mod_seer40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline <span class="op">=</span> <span class="va">mspline40</span>,</span>
<span>                         external<span class="op">=</span><span class="va">cetux_seer</span>, </span>
<span>                         chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                         prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<p>The second includes the trial, registry and population data.
<a id="popplot"></a></p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_seer_pop40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline <span class="op">=</span> <span class="va">mspline40</span>,</span>
<span>                           external<span class="op">=</span><span class="va">cetux_seer</span>, backhaz<span class="op">=</span><span class="va">cetux_bh</span>,</span>
<span>                           chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                           prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<p>The population data “anchors” the extrapolation - the hazard is
constrained to be no less than that of the population, and the resulting
estimates become more precise. There is still a lot of uncertainty,
since (through the knots at 30 and 40 years) we have allowed for the
possibility that the excess hazard changes beyond the point (25-26
years) where we actually have data about it.</p>
<details><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">haz_seer40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_seer40</span>,tmax<span class="op">=</span><span class="fl">40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"With registry data"</span><span class="op">)</span></span>
<span><span class="va">haz_seer_pop40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_seer_pop40</span>,tmax<span class="op">=</span><span class="fl">40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"With registry and population data"</span><span class="op">)</span></span>
<span><span class="va">haz_plot_reg_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">haz_seer40</span>, <span class="va">haz_seer_pop40</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_plot_reg_pop</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, col<span class="op">=</span><span class="va">Model</span>, fill<span class="op">=</span><span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, colour<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_lower</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray60"</span>, lty<span class="op">=</span><span class="fl">2</span>,</span>
<span>              inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_upper</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray60"</span>, lty<span class="op">=</span><span class="fl">2</span>,</span>
<span>              inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_bh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">hazard</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, colour<span class="op">=</span><span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">33</span>, y<span class="op">=</span><span class="fl">0.1</span>, label<span class="op">=</span><span class="st">"Population mortality"</span>, colour<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.9</span><span class="op">)</span>, </span>
<span>          legend.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NULL</span>, fill<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">control</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<img src="cetuximab_files/figure-html/fig_registry_pop40.png" style="display: block; margin: auto;"></details>
</div>
<div class="section level2">
<h2 id="mixture-cure-model">Mixture cure model<a class="anchor" aria-label="anchor" href="#mixture-cure-model"></a>
</h2>
<p>The extrapolation of the excess hazard is still fairly uncertain,
even when both registry and population data are included, since the data
informing the excess hazard finish at 25 years.</p>
<p>In many clinical applications, it is thought that the excess hazard
for a population with a disease will decrease over time, particularly as
people grow older and their all-cause mortality increases. We examine a
couple of ways to use this kind of judgement to improve survival
extrapolations using <code>survextrap</code>. The specific assumptions
used here may or may not be realistic for these patients: this case
study is intended as a demonstration of methods, rather than a full,
clinically-informed investigation of head and neck cancer survival.</p>
<p>One way of modelling a decreasing hazard is through a <em>mixture
cure</em> model. This can also be used to model a decreasing
<em>excess</em> hazard in an additive hazards model. This is simply
specified by setting <code>cure=TRUE</code> in the call to
<code>survextrap</code>.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_cure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline <span class="op">=</span> <span class="va">mspline40</span>,</span>
<span>                       external<span class="op">=</span><span class="va">cetux_seer</span>, backhaz<span class="op">=</span><span class="va">cetux_bh</span>, </span>
<span>                       cure<span class="op">=</span><span class="cn">TRUE</span>, </span>
<span>                       chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                       prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
<p>Optionally, a Beta prior could also be specified for the “cure
fraction” through
e.g. <code>survextrap(..., prior cure = p_beta(1,10))</code>, though the
default uniform prior is used here. The cure fraction is the proportion
of people who will never experience the event of interest. The survival
curve decreases to an asymptote at the cure fraction, hence (informally)
the cure fraction can sometimes be inferred from data by examining the
survival curve. Often however it is weakly informed by data.</p>
<p>In this example, the excess hazard for head and neck cancer patients
is still substantial by the end of the registry data (25 years), so
there is little evidence of “cure” from the data. Therefore the
extrapolations from the fitted cure model are very uncertain <a href="#cureplot">(see below)</a>, and largely overlap with those from
the equivalent model for the same data where cure was not assumed <a href="#popplot">(see above)</a>. In addition, the cure model makes a
strong parametric assumption for the shape of how the hazard decreases
over time.</p>
</div>
<div class="section level2">
<h2 id="elicited-data-to-inform-long-term-extrapolations">Elicited data to inform long-term extrapolations<a class="anchor" aria-label="anchor" href="#elicited-data-to-inform-long-term-extrapolations"></a>
</h2>
<p>An alternative way to build in judgements about longer-term survival
is through expert elicitation, as discussed in the <a href="priors.html">priors vignette</a>.</p>
<p>Here, suppose we are confident that by 40 years, the survival of head
and neck cancer patients will be similar to that of the general
population. Instead of using a parametric cure model, we can create an
artificial external dataset that contains the same information as our
judgement. Here the annual population survival probability is computed
from the hazard stored in <code>cetux_bh</code>, and stored in
<code>pops</code>.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cetux_bh</span> <span class="op">&lt;-</span> <span class="va">cetux_bh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>surv1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">hazard</span><span class="op">*</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pops</span> <span class="op">&lt;-</span> <span class="va">cetux_bh</span><span class="op">$</span><span class="va">surv1</span><span class="op">[</span><span class="fl">39</span><span class="op">]</span></span></code></pre></div>
<p>A <code>Beta(n*pops, n(1-pops))</code> distribution for any
<code>n</code> will have a mean of <code>pops</code>, here 0.72. We then
set <code>n</code> to control the amount of uncertainty around this
prior guess.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/Beta.html" class="external-link">qbeta</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">*</span><span class="va">pops</span>, <span class="fl">1000</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">pops</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.6961908 0.7244400 0.7515403</span></span></code></pre>
<p>The information in this Beta prior is equivalent to having observed
<code>1000*pops</code> survivors out of 1000 people. This gives a
numerator and denominator <code>n</code> and <code>r</code> for survival
between <code>start=39</code> and <code>stop=40</code> years. We use
these to construct a dataset in the format needed by the
<code>external</code> argument to <code>survextrap</code>.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_elic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  start<span class="op">=</span><span class="fl">39</span>, stop<span class="op">=</span><span class="fl">40</span>,</span>
<span>  n <span class="op">=</span> <span class="fl">1000</span>, </span>
<span>  r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">1000</span><span class="op">*</span><span class="va">pops</span><span class="op">)</span>,</span>
<span>  treat <span class="op">=</span> <span class="st">"Control"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This can then be joined to the registry data <code>cetux_seer</code>,
to give an external dataset to supply to <code>survextrap</code>.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pop_cured</span> <span class="op">&lt;-</span> </span>
<span>  <span class="va">cetux_seer</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">full_join</a></span><span class="op">(</span><span class="va">data_elic</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">stop</span>, <span class="va">r</span>, <span class="va">n</span>, <span class="va">treat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mod_cure_elic</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">control</span>, mspline<span class="op">=</span><span class="va">mspline40</span>, </span>
<span>                            external<span class="op">=</span><span class="va">pop_cured</span>, backhaz<span class="op">=</span><span class="va">cetux_bh</span>, </span>
<span>                            chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>,</span>
<span>                            prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span><span class="op">)</span></span></code></pre></div>
The extrapolations of excess hazard from this model are clearly informed
by the elicited survival probability, and pulled closer to the
population data. If we had expressed more confidence in the prior guess
(through a bigger <code>n</code>) the posterior estimates of the hazard
function from the model would have been pulled even closer to the
population data. <a id="cureplot"></a>
<details><div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">haz_cure</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_cure</span>, tmax<span class="op">=</span><span class="fl">40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Mixture cure model"</span><span class="op">)</span></span>
<span><span class="va">haz_cure_elic</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_cure_elic</span>, tmax<span class="op">=</span><span class="fl">40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Model<span class="op">=</span><span class="st">"Elicited survival"</span><span class="op">)</span></span>
<span><span class="va">haz_plot_cure</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">haz_cure</span>, <span class="va">haz_cure_elic</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_plot_cure</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">t</span>, y<span class="op">=</span><span class="va">median</span>, col<span class="op">=</span><span class="va">Model</span>, fill<span class="op">=</span><span class="va">Model</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin<span class="op">=</span><span class="va">lower</span>, ymax<span class="op">=</span><span class="va">upper</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span>, colour<span class="op">=</span><span class="cn">NA</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_lower</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray60"</span>, lty<span class="op">=</span><span class="fl">2</span>,</span>
<span>              inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_seer</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">start</span>, y<span class="op">=</span><span class="va">haz_upper</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"gray60"</span>, lty<span class="op">=</span><span class="fl">2</span>,</span>
<span>              inherit.aes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_step</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">cetux_bh</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&lt;</span> <span class="fl">40</span><span class="op">)</span>, </span>
<span>              <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">hazard</span><span class="op">)</span>, inherit.aes <span class="op">=</span> <span class="cn">FALSE</span>, col<span class="op">=</span><span class="st">"darkgreen"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span>geom<span class="op">=</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">20</span>, y<span class="op">=</span><span class="fl">0</span>, label<span class="op">=</span><span class="st">"Population mortality"</span>, col<span class="op">=</span><span class="st">"darkgreen"</span>, size<span class="op">=</span><span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>panel.grid.major <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, panel.grid.minor <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years after diagnosis"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_color_viridis</a></span><span class="op">(</span>discrete<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">control</span><span class="op">$</span><span class="va">years</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.9</span><span class="op">)</span>, </span>
<span>          legend.background<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>col<span class="op">=</span><span class="cn">NULL</span>, fill<span class="op">=</span><span class="cn">NULL</span><span class="op">)</span> </span></code></pre></div>
<img src="cetuximab_files/figure-html/fig_cure.png" style="display: block; margin: auto;"></details>
</div>
<div class="section level2">
<h2 id="table-of-mean-survival-times">Table of mean survival times<a class="anchor" aria-label="anchor" href="#table-of-mean-survival-times"></a>
</h2>
<p>A table of results for the paper is now constructed and formatted. We
compare restricted mean survival times, over various time horizons,
estimated from the various models fitted to the control group data.</p>
<p>The models are categorised by what data are included, and what
assumptions are made about survival beyond the data.</p>
<details><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fl">4000</span></span>
<span></span>
<span><span class="va">rcon</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_con</span>, t<span class="op">=</span><span class="fl">5</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial"</span>,extrap<span class="op">=</span><span class="st">"No extrapolation"</span><span class="op">)</span></span>
<span><span class="va">rcon20</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_con</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial"</span>, extrap<span class="op">=</span><span class="st">"Uncertain hazard"</span><span class="op">)</span></span>
<span><span class="va">rcon520</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_con5</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial"</span>, extrap<span class="op">=</span><span class="st">"Constant hazard"</span><span class="op">)</span></span>
<span><span class="va">rreg20</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_seer</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial,registry"</span>,extrap<span class="op">=</span><span class="st">"No extrapolation"</span><span class="op">)</span></span>
<span><span class="va">rreg40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_seer40</span>, t<span class="op">=</span><span class="fl">40</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial,registry"</span>, extrap<span class="op">=</span><span class="st">"Uncertain hazard"</span><span class="op">)</span></span>
<span><span class="va">rpop40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_seer_pop40</span>, t<span class="op">=</span><span class="fl">40</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial,registry,population"</span>,extrap<span class="op">=</span><span class="st">"Uncertain excess hazard"</span><span class="op">)</span></span>
<span><span class="va">rcure40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_cure</span>, t<span class="op">=</span><span class="fl">40</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial,registry,population"</span>, </span>
<span>         extrap<span class="op">=</span><span class="st">"Mixture cure"</span><span class="op">)</span></span>
<span><span class="va">relic40</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_cure_elic</span>, t<span class="op">=</span><span class="fl">40</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="st">"Trial,registry,population"</span>, </span>
<span>         extrap<span class="op">=</span><span class="st">"Elicited survival"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">modlabs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(1a)"</span>, <span class="st">"(1a)"</span>, <span class="st">"(1b)"</span>, <span class="st">"(1c)"</span>, <span class="st">"(1d)"</span>,<span class="st">"(1e)"</span>, <span class="st">"(1f)"</span>, <span class="st">"(1g)"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">rcon</span>, <span class="va">rcon20</span>, <span class="va">rcon520</span>, <span class="va">rreg20</span>, <span class="va">rreg40</span>, <span class="va">rpop40</span>, <span class="va">rcure40</span>, <span class="va">relic40</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/reduce.html" class="external-link">reduce</a></span><span class="op">(</span><span class="va">full_join</span>, by <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/join_by.html" class="external-link">join_by</a></span><span class="op">(</span><span class="va">variable</span>, <span class="va">t</span>, <span class="va">median</span>, <span class="va">`lower`</span>, <span class="va">`upper`</span>, <span class="va">data</span>, <span class="va">extrap</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>modlabs<span class="op">=</span><span class="va">modlabs</span>,</span>
<span>         rmst <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s, %s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">median</span>,<span class="fl">2</span><span class="op">)</span>, </span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`lower`</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">`upper`</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">modlabs</span>, <span class="va">data</span>, <span class="va">extrap</span>, <span class="va">t</span>, <span class="va">rmst</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">rs</span>, col.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Model"</span>, <span class="st">"Observed data"</span>,<span class="st">"Extrapolation assumptions"</span>,</span>
<span>                             <span class="st">"Time horizon"</span>,<span class="st">"Restricted mean survival"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="6%">
<col width="27%">
<col width="27%">
<col width="13%">
<col width="26%">
</colgroup>
<thead><tr class="header">
<th align="left">Model</th>
<th align="left">Observed data</th>
<th align="left">Extrapolation assumptions</th>
<th align="right">Time horizon</th>
<th align="left">Restricted mean survival</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">(1a)</td>
<td align="left">Trial</td>
<td align="left">No extrapolation</td>
<td align="right">5</td>
<td align="left">2.88 (2.63, 3.14)</td>
</tr>
<tr class="even">
<td align="left">(1a)</td>
<td align="left">Trial</td>
<td align="left">Uncertain hazard</td>
<td align="right">20</td>
<td align="left">5.11 (3.83, 7.28)</td>
</tr>
<tr class="odd">
<td align="left">(1b)</td>
<td align="left">Trial</td>
<td align="left">Constant hazard</td>
<td align="right">20</td>
<td align="left">5.12 (4, 6.68)</td>
</tr>
<tr class="even">
<td align="left">(1c)</td>
<td align="left">Trial,registry</td>
<td align="left">No extrapolation</td>
<td align="right">20</td>
<td align="left">5.77 (5.03, 6.6)</td>
</tr>
<tr class="odd">
<td align="left">(1d)</td>
<td align="left">Trial,registry</td>
<td align="left">Uncertain hazard</td>
<td align="right">40</td>
<td align="left">6.19 (5.33, 7.17)</td>
</tr>
<tr class="even">
<td align="left">(1e)</td>
<td align="left">Trial,registry,population</td>
<td align="left">Uncertain excess hazard</td>
<td align="right">40</td>
<td align="left">6.21 (5.38, 7.14)</td>
</tr>
<tr class="odd">
<td align="left">(1f)</td>
<td align="left">Trial,registry,population</td>
<td align="left">Mixture cure</td>
<td align="right">40</td>
<td align="left">6.28 (5.39, 7.19)</td>
</tr>
<tr class="even">
<td align="left">(1g)</td>
<td align="left">Trial,registry,population</td>
<td align="left">Elicited survival</td>
<td align="right">40</td>
<td align="left">6.25 (5.36, 7.2)</td>
</tr>
</tbody>
</table></details><p>The following code formats the table in LaTeX format (for the
paper).</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">rs</span>, sep<span class="op">=</span><span class="st">"  &amp;  "</span>, eol<span class="op">=</span><span class="st">"\\\\\n"</span>, quote<span class="op">=</span><span class="cn">FALSE</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## modlabs  &amp;  data  &amp;  extrap  &amp;  t  &amp;  rmst\\</span></span>
<span><span class="co">## (1a)  &amp;  Trial  &amp;  No extrapolation  &amp;  5  &amp;  2.88 (2.63, 3.14)\\</span></span>
<span><span class="co">## (1a)  &amp;  Trial  &amp;  Uncertain hazard  &amp;  20  &amp;  5.11 (3.83, 7.28)\\</span></span>
<span><span class="co">## (1b)  &amp;  Trial  &amp;  Constant hazard  &amp;  20  &amp;  5.12 (4, 6.68)\\</span></span>
<span><span class="co">## (1c)  &amp;  Trial,registry  &amp;  No extrapolation  &amp;  20  &amp;  5.77 (5.03, 6.6)\\</span></span>
<span><span class="co">## (1d)  &amp;  Trial,registry  &amp;  Uncertain hazard  &amp;  40  &amp;  6.19 (5.33, 7.17)\\</span></span>
<span><span class="co">## (1e)  &amp;  Trial,registry,population  &amp;  Uncertain excess hazard  &amp;  40  &amp;  6.21 (5.38, 7.14)\\</span></span>
<span><span class="co">## (1f)  &amp;  Trial,registry,population  &amp;  Mixture cure  &amp;  40  &amp;  6.28 (5.39, 7.19)\\</span></span>
<span><span class="co">## (1g)  &amp;  Trial,registry,population  &amp;  Elicited survival  &amp;  40  &amp;  6.25 (5.36, 7.2)\\</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="waning-models-for-long-term-treatment-effects">Waning models for long-term treatment effects<a class="anchor" aria-label="anchor" href="#waning-models-for-long-term-treatment-effects"></a>
</h2>
<p>Finally, we estimate the effect of treatment with cetuximab on
long-term survival. We extend two of the models with external data
(fitted earlier to just the control group) to include a treatment effect
and fit them to the full trial data <code>cetux</code>. Firstly, the
model with trial and registry data, and secondly, the model with all
three data sources (trial, registry and population, but no “cure”
assumption). The proportional hazards model is assumed, which was
adequate to describe the short-term data.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_full_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span>, mspline <span class="op">=</span> <span class="va">mspline40</span>,</span>
<span>                           external<span class="op">=</span><span class="va">cetux_seer</span>, </span>
<span>                           chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                           prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span>, </span>
<span>                           prior_loghr <span class="op">=</span> <span class="va">prior_loghr</span><span class="op">)</span></span>
<span><span class="va">mod_full_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">d</span><span class="op">)</span> <span class="op">~</span> <span class="va">treat</span>, data<span class="op">=</span><span class="va">cetux</span>, mspline <span class="op">=</span> <span class="va">mspline40</span>,</span>
<span>                           external<span class="op">=</span><span class="va">cetux_seer</span>, backhaz<span class="op">=</span><span class="va">cetux_bh</span>,</span>
<span>                           chains<span class="op">=</span><span class="va">chains</span>, iter<span class="op">=</span><span class="va">iter</span>, </span>
<span>                           prior_hscale<span class="op">=</span><span class="va">prior_hscale</span>, prior_hsd <span class="op">=</span> <span class="va">prior_hsd</span>, </span>
<span>                           prior_loghr <span class="op">=</span> <span class="va">prior_loghr</span><span class="op">)</span></span></code></pre></div>
<p>The restricted mean survival for the control group, and the increase
in the restricted mean survival given by cetuximab, is estimated under
various “treatment effect waning” assumptions. Essentially these assume
that the log hazard ratio for a “treated” group decreases linearly over
some time period from the “treated” estimate to the “control” estimate.
This is done by mixing the posteriors of treated and control estimates
obtained from the same model, in this case <code>mod_full_pop</code>
(see the <a href="methods.html#waning">methods vignette</a>).</p>
<p>The calls to <code>rmst</code> and <code>irmst</code> are modified to
include a <code>wane_period</code> (vector defining the start and end of
the waning period). We also supply <code>newdata</code> and
<code>newdata0</code>, which indicate respectively what covariate values
in the model correspond to “treated” and “control” groups.</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Cetuximab"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nd0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ind</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>,<span class="st">"Cetuximab"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ind0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>treat<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Control"</span>,<span class="st">"Control"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">cetux</span><span class="op">$</span><span class="va">years</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ni</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="co">## 20 year absolute survival</span></span>
<span><span class="va">rmnwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_full_reg</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">rmnw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_full_pop</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">rmw6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_full_pop</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span>, newdata<span class="op">=</span><span class="va">nd</span>, newdata0<span class="op">=</span><span class="va">nd0</span>, </span>
<span>             wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmax</span>, <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">rmw20</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">mod_full_pop</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span>, newdata<span class="op">=</span><span class="va">nd</span>, newdata0<span class="op">=</span><span class="va">nd0</span>, </span>
<span>              wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmax</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## 20 year incremental survival for cetuximab</span></span>
<span><span class="va">irmnwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/irmst.html">irmst</a></span><span class="op">(</span><span class="va">mod_full_reg</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">irmnw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/irmst.html">irmst</a></span><span class="op">(</span><span class="va">mod_full_pop</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">irmw6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/irmst.html">irmst</a></span><span class="op">(</span><span class="va">mod_full_pop</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span>, newdata <span class="op">=</span> <span class="va">ind</span>, newdata0 <span class="op">=</span> <span class="va">ind0</span>, </span>
<span>               wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmax</span>,<span class="fl">6</span><span class="op">)</span>, wane_nt <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">6</span><span class="op">)</span></span>
<span><span class="va">irmw20</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/irmst.html">irmst</a></span><span class="op">(</span><span class="va">mod_full_pop</span>, t<span class="op">=</span><span class="fl">20</span>, niter<span class="op">=</span><span class="va">ni</span>, newdata <span class="op">=</span> <span class="va">ind</span>, newdata0 <span class="op">=</span> <span class="va">ind0</span>, </span>
<span>                wane_period <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tmax</span>,<span class="fl">20</span><span class="op">)</span>, wane_nt <span class="op">=</span> <span class="fl">5</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>wane<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rmd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">rmnwr</span>, <span class="va">rmnw</span>, <span class="va">rmw6</span>, <span class="va">rmw20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">treat</span><span class="op">==</span><span class="st">"Control"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>rm<span class="op">=</span><span class="st">"median"</span>,rmlower<span class="op">=</span><span class="st">"lower"</span>,rmupper<span class="op">=</span><span class="st">"upper"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"reg"</span>,<span class="st">"pop"</span><span class="op">)</span>,</span>
<span>           rmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s, %s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rm</span>,<span class="fl">2</span><span class="op">)</span>, </span>
<span>                         <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rmlower</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">rmupper</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">wane</span>, <span class="va">rmf</span><span class="op">)</span> </span>
<span><span class="va">irmd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">irmnwr</span>, <span class="va">irmnw</span>, <span class="va">irmw6</span>, <span class="va">irmw20</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>irm<span class="op">=</span><span class="st">"median"</span>,irmlower<span class="op">=</span><span class="st">"lower"</span>,irmupper<span class="op">=</span><span class="st">"upper"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"reg"</span>,<span class="st">"pop"</span>,<span class="st">"pop"</span>,<span class="st">"pop"</span><span class="op">)</span>,</span>
<span>           irmf <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s (%s, %s)"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">irm</span>,<span class="fl">2</span><span class="op">)</span>, </span>
<span>                          <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">irmlower</span>,<span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">irmupper</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">wane</span>, <span class="va">irmf</span><span class="op">)</span></span>
<span><span class="va">res_wane</span> <span class="op">&lt;-</span> <span class="va">rmd</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">wane</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">right_join</a></span><span class="op">(</span><span class="va">irmd</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"data"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>model<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"(2d) No waning"</span>,<span class="st">"(2e) No waning"</span>,</span>
<span>                 <span class="st">"(2e) 5 to 6 years"</span>, <span class="st">"(2e) 5 to 20 years"</span><span class="op">)</span>,</span>
<span>           looic <span class="op">=</span> <span class="st">""</span>,</span>
<span>           rmf <span class="op">=</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/replace_na.html" class="external-link">replace_na</a></span><span class="op">(</span><span class="va">rmf</span>, <span class="st">""</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">model</span>, <span class="va">rmf</span>, <span class="va">irmf</span>, <span class="va">looic</span><span class="op">)</span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">res_wane</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">looic</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Trial,registry"</span>,<span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"Trial,registry,population"</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>             <span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span>,</span>
<span>             col.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Data"</span>,<span class="st">"Model"</span>,<span class="st">"Restricted mean survival"</span>,</span>
<span>                         <span class="st">"Increase in restricted mean survival"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<colgroup>
<col width="24%">
<col width="17%">
<col width="23%">
<col width="34%">
</colgroup>
<thead><tr class="header">
<th align="left">Data</th>
<th align="left">Model</th>
<th align="left">Restricted mean survival</th>
<th align="left">Increase in restricted mean survival</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Trial,registry</td>
<td align="left">(2d) No waning</td>
<td align="left">5.83 (5.06, 6.58)</td>
<td align="left">1.22 (-0.31, 2.91)</td>
</tr>
<tr class="even">
<td align="left">Trial,registry,population</td>
<td align="left">(2e) No waning</td>
<td align="left">5.88 (5.15, 6.72)</td>
<td align="left">1.04 (-0.32, 2.52)</td>
</tr>
<tr class="odd">
<td align="left">Trial,registry,population</td>
<td align="left">(2e) 5 to 6 years</td>
<td align="left">5.88 (5.15, 6.72)</td>
<td align="left">0.79 (-0.24, 1.86)</td>
</tr>
<tr class="even">
<td align="left">Trial,registry,population</td>
<td align="left">(2e) 5 to 20 years</td>
<td align="left">5.88 (5.15, 6.72)</td>
<td align="left">0.99 (-0.3, 2.39)</td>
</tr>
</tbody>
</table>
<p>Table in LaTeX format (for the paper).</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/write.table.html" class="external-link">write.table</a></span><span class="op">(</span><span class="va">res_wane</span>, eol<span class="op">=</span><span class="st">"\\\\\n"</span>, sep<span class="op">=</span><span class="st">"  &amp;  "</span>, row.names <span class="op">=</span> <span class="cn">FALSE</span>, quote<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## model  &amp;  rmf  &amp;  irmf  &amp;  looic\\</span></span>
<span><span class="co">## (2d) No waning  &amp;  5.83 (5.06, 6.58)  &amp;  1.22 (-0.31, 2.91)  &amp;  \\</span></span>
<span><span class="co">## (2e) No waning  &amp;  5.88 (5.15, 6.72)  &amp;  1.04 (-0.32, 2.52)  &amp;  \\</span></span>
<span><span class="co">## (2e) 5 to 6 years  &amp;  5.88 (5.15, 6.72)  &amp;  0.79 (-0.24, 1.86)  &amp;  \\</span></span>
<span><span class="co">## (2e) 5 to 20 years  &amp;  5.88 (5.15, 6.72)  &amp;  0.99 (-0.3, 2.39)  &amp;  \\</span></span></code></pre>
<p>Using all three data sources, with no waning, the incremental
restricted mean survival over 20 years is estimated as 1.04 (-0.32,
2.52). This reduces to 0.99 (-0.3, 2.39) when waning is applied
gradually from 6 to 20 years, and even further to 0.79 (-0.24, 1.86)
when the effect is assumed to wane rapidly from 5 to 6 years.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
