<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Priors in survextrap models • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Priors in survextrap models">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.15</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cetuximab.html">Case study of using survextrap: cetuximab for head and neck cancer</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
    <a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a>
    <a class="dropdown-item" href="../articles/sbc.html">Simulation-based calibration of survextrap</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Priors in survextrap models</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/priors.Rmd" class="external-link"><code>vignettes/priors.Rmd</code></a></small>
      <div class="d-none name"><code>priors.Rmd</code></div>
    </div>

    
    
<p>The flexible survival models in <code>survextrap</code> are
<strong>Bayesian</strong>.</p>
<p>This means that they analyse data under a <strong>parametric</strong>
model, which assumes that each data point <span class="math inline">\(x\)</span> comes from a sampling distribution with
probability density function <span class="math inline">\(f(x|\theta)\)</span>. The parameters <span class="math inline">\(\theta\)</span> are estimated by combining a
<strong>prior</strong> distribution <span class="math inline">\(p(\theta)\)</span>, representing beliefs about
model parameters external to the data, with a
<strong>“likelihood”</strong> that represents the information from a set
of data <span class="math inline">\(\boldsymbol{x}\)</span>, producing a
posterior distribution <span class="math inline">\(p(\theta |
\boldsymbol{x})\)</span>.</p>
<p>The principle behind the package is that any information that is
relevant to extrapolation should be represented transparently. This is
arguably clearest if expressed through <strong>data</strong> or
<strong>parametric mechanisms</strong>.</p>
<ul>
<li><p><strong>Data</strong> x include individual-level, right-censored
survival data, and aggregate counts of survivors, as described on the
front page. Expert judgements about survival can be converted to
pseudo-data in the form of aggregate counts.</p></li>
<li>
<p><strong>Parametric mechanisms</strong> denote the form of <span class="math inline">\(f()\)</span>. These might include the notion that
some people are cured (mixture cure models), or that disease-specific
and background hazards can be modelled additively (relative survival
models). Conventional parametric survival models (like the Weibull and
log-logistic) are generally used out of familiarity, not because they
are thought to represent meaningful mechanisms for survival.</p>
<p>The default parametric model in <code>survextrap</code> is a flexible
spline-based model. This is designed as a “black box”, which aims to fit
the data as well as possible. It is not designed to be treated as a
mechanism for extrapolation.</p>
</li>
</ul>
<p>However, this spline model has parameters <span class="math inline">\(\theta\)</span>, which still need prior
distributions, because the model is Bayesian!</p>
<p>This article describes these two kinds of “prior” judgements that can
be used in <code>survextrap</code> models.</p>
<ol style="list-style-type: decimal">
<li><p>Judgements about survival probabilities, that can be converted to
pseudo-data, and treated as part of the model likelihood for data <span class="math inline">\(\boldsymbol{x}\)</span>.</p></li>
<li><p>Priors on parameters <span class="math inline">\(\theta\)</span>
in spline models.</p></li>
</ol>
<div class="section level2">
<h2 id="converting-prior-judgements-about-survival-to-external-data">Converting prior judgements about survival to external data<a class="anchor" aria-label="anchor" href="#converting-prior-judgements-about-survival-to-external-data"></a>
</h2>
<p>We suppose there is some expert judgement about survival over the
time period from <span class="math inline">\(t\)</span> to <span class="math inline">\(u\)</span>, and we can “elicit” this as the
probability <span class="math inline">\(p\)</span> that a person who is
alive at <span class="math inline">\(t\)</span> will have died before
<span class="math inline">\(u\)</span>.</p>
<p>This elicitation might be done in many ways (e.g. through consensus
methods, or consulting multiple experts and aggregating their beliefs).
<code>survextrap</code> does not include tools or guidance for doing
elicitation, but further info is available, e.g. from <a href="https://journals.sagepub.com/doi/pdf/10.1177/0272989X211028236" class="external-link">Bojke
et al.</a>, or <a href="https://shelf.sites.sheffield.ac.uk/" class="external-link">SHELF</a>.</p>
<p>One simple way is to elicit:</p>
<ul>
<li><p>a best guess for what <span class="math inline">\(p\)</span> is.
We could interpret this as the <em>median</em> of the prior
distribution.</p></li>
<li><p>upper and lower prior credible limits, such that we are (for
example) 90% sure that <span class="math inline">\(p\)</span> is within
this range. We can interpret these as the 5% and 95% quantiles.</p></li>
</ul>
<p>As an example, suppose we elicited a best guess of 0.6, and a 90%
credible interval of 0.4 to 0.8. These can be fitted to a
<em>probability distribution</em> representing beliefs about <span class="math inline">\(p\)</span>. The SHELF R package provides a useful
function, <code>fitdist</code>, to do this. We use this to fit a
<em>Beta</em> distribution, a typically-used distribution for
probabilities.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/OakleyJ/SHELF" class="external-link">SHELF</a></span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">bet</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/SHELF/man/fitdist.html" class="external-link">fitdist</a></span><span class="op">(</span>vals<span class="op">=</span><span class="va">p</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.5</span>, <span class="fl">0.95</span><span class="op">)</span>, lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">Beta</span></span>
<span><span class="va">bet</span></span></code></pre></div>
<pre><code><span><span class="co">##     shape1  shape2</span></span>
<span><span class="co">## 1 9.190895 6.19854</span></span></code></pre>
<p>This gives a Beta(9.2, 6.2) distribution. We can plot its probability
density function, to check that the distribution represents the beliefs
about <span class="math inline">\(p\)</span> that we intended to
use:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>p <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_function.html" class="external-link">stat_function</a></span><span class="op">(</span>fun <span class="op">=</span> <span class="va">dbeta</span>, args<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>shape1<span class="op">=</span><span class="va">bet</span><span class="op">$</span><span class="va">shape1</span>, shape2<span class="op">=</span><span class="va">bet</span><span class="op">$</span><span class="va">shape2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Density"</span><span class="op">)</span></span></code></pre></div>
<p><img src="priors_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<p>We now convert the elicited Beta distribution to pseudo-data.</p>
<p>The trick for doing this comes from a basic result about Bayesian
estimation of an event probability <span class="math inline">\(p\)</span>. Suppose we start with a Beta<span class="math inline">\((a,b)\)</span> prior for <span class="math inline">\(p\)</span>, and observe <span class="math inline">\(y\)</span> events out of <span class="math inline">\(n\)</span> individual observations, where each
observation may or may not have resulted in an event, so that <span class="math inline">\(y\)</span> comes from a Binomial distribution with
probability <span class="math inline">\(p\)</span>. The posterior for
<span class="math inline">\(p\)</span> is then Beta<span class="math inline">\((a+y, b+n-y)\)</span>.</p>
<p>We can then equate our elicited belief (call it Beta<span class="math inline">\((e_1, e_2)\)</span>, say) with a posterior
distribution under a vague prior (say a Beta<span class="math inline">\((a=0,b=0)\)</span>). Therefore <span class="math inline">\(e_1=a+y\)</span> and <span class="math inline">\(e_2 = b+n-y\)</span>, hence <span class="math inline">\(y=e_1\)</span>, <span class="math inline">\(n =
e_1 + e_2\)</span>.</p>
<p>In other words, our elicited Beta<span class="math inline">\((e_1,e_2)\)</span> distribution is equivalent to
the knowledge from an aggregate count of <span class="math inline">\(e_1\)</span> events out of <span class="math inline">\(e_1 + e_2\)</span> observations. This aggregate
“pseudo-data” can be used as an <code>external</code> data source in
<code>survextrap</code>.</p>
<p>For example, the Beta(9,6) distribution above is equivalent to
pseudo-data of 9 events out of 15 trials. The point estimate of the
event probability from this data would be 9/15 = 0.6 (our original
guess). A pseudo-dataset of 90 events out of 150 trials would have the
same median, but a narrower credible interval, since the dataset is
larger, implying greater confidence that the true <span class="math inline">\(p\)</span> is near to the point estimate.</p>
<div class="section level4">
<h4 id="further-notes-on-elicitation">Further notes on elicitation<a class="anchor" aria-label="anchor" href="#further-notes-on-elicitation"></a>
</h4>
<ul>
<li><p>Academic note: there are different ways of defining a vague Beta
prior for a probability. Beta<span class="math inline">\((0,0)\)</span>
is a uniform distribution for the log odds <span class="math inline">\(\log(p/(1-p))\)</span>, and Beta<span class="math inline">\((1,1)\)</span> is uniform on the scale of the
probability <span class="math inline">\(p\)</span>. The “Jeffreys” prior
Beta<span class="math inline">\((0.5, 0.5)\)</span> is sometimes used as
a compromise between these. The difference between these choices is
unlikely to matter in practice.</p></li>
<li><p>We could elicit survival probabilities over different time
intervals, and use these as multiple <code>external</code> datasets in
<code>survextrap</code>.</p></li>
<li><p>It would probably not be appropriate to include beliefs about the
same quantity, elicited from multiple experts, as multiple external
datasets in <code>survextrap</code>. This is because the experts may
have shared beliefs based on their common knowledge of the field. If
multiple experts are consulted about the same quantity, their beliefs
should be aggregated into a single distribution before using
<code>survextrap</code>, e.g. by using mathematical aggregation or a
consensus method. Again, see, e.g. <a href="https://journals.sagepub.com/doi/pdf/10.1177/0272989X211028236" class="external-link">Bojke
et al.</a> or <a href="https://shelf.sites.sheffield.ac.uk/" class="external-link">SHELF</a>,
for more information about elicitation.</p></li>
</ul>
<!-- [Do we want an illustration of a survextrap model here?] -->
</div>
</div>
<div class="section level2">
<h2 id="priors-on-spline-parameters">Priors on spline parameters<a class="anchor" aria-label="anchor" href="#priors-on-spline-parameters"></a>
</h2>
<p>The parameters of the spline model are mathematical abstractions
which do not have meaningful interpretations such as means or variances
for survival times. However for Bayesian modelling, we still have to
place priors on them.</p>
<p>A general way to ensure that the chosen priors represent meaningful
beliefs is through <em>simulation</em>. <code>survextrap</code> provides
some tools for this.</p>
<div class="section level3">
<h3 id="plotting-plausible-hazard-trajectories">Plotting plausible hazard trajectories<a class="anchor" aria-label="anchor" href="#plotting-plausible-hazard-trajectories"></a>
</h3>
<p>Before fitting a model, we can use the
<code>prior_sample_hazard</code> function to check that hazard curves
simulated from the prior would be considered plausible representations
of the knowledge that exists outside the data.</p>
<p>To use this before the model is fitted, we have to know the knots
defining the spline, and choose a set of priors. <code>survextrap</code>
provides a set of default priors, which may or may not be sensible in a
given application. and a procedure for picking knots (see the <a href="../methods.html#bayesspec">methods vignette</a>).</p>
<p>First we fit a default model, and print the default priors that are
used.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="va">nd_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, fit_method<span class="op">=</span><span class="st">"opt"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/print_priors.html">print_priors</a></span><span class="op">(</span><span class="va">nd_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Priors:</span></span>
<span><span class="co">##   Baseline log hazard scale: normal(location=0,scale=20)</span></span>
<span><span class="co">##   Smoothness SD: gamma(shape=2,rate=1)</span></span></code></pre>
<p>The “baseline log hazard scale” parameter is the parameter <span class="math inline">\(\log(\eta)\)</span> in the definition of the
M-spline function for the hazard: <span class="math inline">\(h(t) =
\eta \sum_k p_k b_k(t)\)</span>. By itself, <span class="math inline">\(\eta\)</span> does not define a hazard. It only
defines a hazard after being combined with the basis coefficients <span class="math inline">\(p_k\)</span> and basis terms <span class="math inline">\(b_k()\)</span>.</p>
<p>The “smoothness SD” is the parameter <span class="math inline">\(\sigma\)</span> . This is even harder to interpret
than <span class="math inline">\(\eta\)</span>. Values of <span class="math inline">\(\sigma=0\)</span> represent certainty that the
hazard is the one defined by the prior mean for the <span class="math inline">\(p_k\)</span>. Values of 1 or more favour wiggly
hazard curves, while very high values are <a href="methods.html#priorhaz">not meaningful</a>.</p>
<p>The prior mean for the <span class="math inline">\(p_k\)</span> can
be examined in <code>coefs_mean</code> - by default, this defines a
hazard function <span class="math inline">\(h(t)\)</span> that is
constant over time. The number and location of knots can also be
examined in the <code>mspline</code> component of the model.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">nd_mod</span><span class="op">$</span><span class="va">coefs_mean</span>,<span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">sp</span> <span class="op">&lt;-</span> <span class="va">nd_mod</span><span class="op">$</span><span class="va">mspline</span></span></code></pre></div>
<p>Together, these knots and prior choices define the model to be fitted
to the data. We can now simulate the consequences of these choices, in
terms of:</p>
<ul>
<li><p>the typical level of the hazard</p></li>
<li><p>what range of hazard trajectories are plausible</p></li>
<li><p>how much the hazard tends to vary through time</p></li>
</ul>
<p>The fitted model object (<code>nd_mod</code> here) has a component
called <code>prior_sample</code>, which is a list of functions that can
be used to simulate various interesting quantities from this prior
specification.</p>
<div class="section level5">
<h5 id="constant-hazard-level">Constant hazard level<a class="anchor" aria-label="anchor" href="#constant-hazard-level"></a>
</h5>
<p>The first thing to verify is the typical level of the hazard. If no
prior for the hazard scale parameter <span class="math inline">\(\eta\)</span> is supplied in
<code>survextrap</code>, then a default <span class="math inline">\(N(0,20)\)</span> is used, which is very vague. We
can illustrate the implications of this choice by deriving the prior for
the constant hazard <span class="math inline">\(h(t) = \eta \sum_k p_k
b_k(t)\)</span> which is implied by the prior for <span class="math inline">\(\eta\)</span> and the special values of <span class="math inline">\(p_k\)</span> that imply a constant hazard (found
using <code><a href="../reference/mspline_constant_coefs.html">mspline_constant_coefs()</a></code>).</p>
<p>The <code>haz_const</code> function returns a summary of the implied
prior for this constant hazard, and the implied prior for the mean
survival time <span class="math inline">\(1/h(t)\)</span>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_mod</span><span class="op">$</span><span class="va">prior_sample</span><span class="op">$</span><span class="fu">haz_const</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                haz         mean</span></span>
<span><span class="co">## 2.5%  8.336083e-18 1.073931e-17</span></span>
<span><span class="co">## 50%   8.810345e-01 1.135029e+00</span></span>
<span><span class="co">## 97.5% 9.311588e+16 1.199604e+17</span></span></code></pre>
<p>These credible limits are extreme. Perhaps this is reasonable if the
dataset is large and would dominate any choice of prior. In most
applications, however, we have some idea of what a typical survival time
should be, hence what a typical hazard should be, say within an order or
two of magnitude.</p>
<p>A simple heuristic is to specify</p>
<ul>
<li><p>a prior guess (e.g. we guess that average survival time is 50
years after the start of the study)</p></li>
<li><p>a prior upper credible limit (e.g. we guess it is unlikely that
the mean survival time is 80 years after the start of the study). Note
that this represents uncertainty about the mean survival in a
population, rather than the variability between individuals in the
population, so perhaps the credible interval should be narrower than you
think.</p></li>
<li><p>hence giving a median and lower credible limit for <span class="math inline">\(h(t)\)</span>, hence (after dividing by the
constant <span class="math inline">\(\sum_k p_k b_k(t)\)</span> for an
arbitrary <span class="math inline">\(t\)</span> and logging), giving a
median <span class="math inline">\(m\)</span> and lower credible limit
<span class="math inline">\(L\)</span> for <span class="math inline">\(\log(\eta)\)</span>. Hence a normal prior for
<span class="math inline">\(\log(\eta)\)</span> can be defined with
median <span class="math inline">\(m\)</span>, and standard deviation
<span class="math inline">\((L-m)/2\)</span>.</p></li>
</ul>
<p>This is implemented in the function <code>p_meansurv</code>. Note
that a spline knot specification is required to obtain the constant
<span class="math inline">\(\sum_k p_k b_k(t)\)</span>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span></span></code></pre></div>
<p>For a given prior on <span class="math inline">\(\eta\)</span> and
spline specification, the function <code>prior_haz_const</code> can be
used to summarise the implied prior on the constant hazard and mean
survival time. We use this now to check that the prior that we defined
with <code>p_meansurv</code> is the one that we intended to define.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prior_haz_const.html">prior_haz_const</a></span><span class="op">(</span>mspline<span class="op">=</span><span class="va">sp</span>, </span>
<span>                prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          haz  mean</span></span>
<span><span class="co">## 2.5%  0.0125 31.25</span></span>
<span><span class="co">## 50%   0.0200 50.00</span></span>
<span><span class="co">## 97.5% 0.0320 80.00</span></span></code></pre>
<p>The prior median and upper credible limit match the numbers that we
put in. We also get a lower 2.5% credible limit as a consequence of the
normal assumption - this should be checked for plausibility, and the
prior revised if necessary.</p>
<p>Finally, an updated <code>survextrap</code> model can be fitted that
includes the weakly informative prior that we defined and checked. For
reporting purposes, we can use <code>print_priors</code> to view the
normal prior for <span class="math inline">\(\log(\eta)\)</span> that
was automatically derived.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ndi_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, fit_method<span class="op">=</span><span class="st">"opt"</span>,</span>
<span>                      prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/print_priors.html">print_priors</a></span><span class="op">(</span><span class="va">ndi_mod</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Priors:</span></span>
<span><span class="co">##   Baseline log hazard scale: normal(location=-3.7853644873736,scale=0.2398021764446)</span></span>
<span><span class="co">##   Smoothness SD: gamma(shape=2,rate=1)</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="hazard-as-a-function-of-time">Hazard as a function of time<a class="anchor" aria-label="anchor" href="#hazard-as-a-function-of-time"></a>
</h5>
<p>The <code>prior_sample</code> component includes a function called
<code>haz</code> which simulates a desired number of hazard trajectories
over time, given the prior. This function returns a data frame (here
called <code>haz_sim</code>) which contains the hazard value
<code>haz</code>, time point <code>time</code> and simulation replicate
<code>rep</code>.</p>
<p>Here we simulate <code>nsim=30</code> prior hazard trajectories from
the model <code>ndi_mod</code>, and plot them with
<code>ggplot</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">haz_sim</span> <span class="op">&lt;-</span> <span class="va">ndi_mod</span><span class="op">$</span><span class="va">prior_sample</span><span class="op">$</span><span class="fu">haz</span><span class="op">(</span>nsim<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_sim</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span>, group<span class="op">=</span><span class="va">rep</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<p><img src="priors_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>An alternative way is to use the <code>prior_sample_hazard</code>
function, which does not require a model to be specified with the
<code>survextrap</code> function, but does require the knots and priors
to be supplied explicitly.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">haz_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_sample_hazard.html">prior_sample_hazard</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">sp</span><span class="op">$</span><span class="va">knots</span>, degree<span class="op">=</span><span class="va">sp</span><span class="op">$</span><span class="va">degree</span>, </span>
<span>                               coefs_mean <span class="op">=</span> <span class="va">ndi_mod</span><span class="op">$</span><span class="va">coefs_mean</span>,   </span>
<span>                               prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>,   </span>
<span>                               prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span>,</span>
<span>                               tmax<span class="op">=</span><span class="fl">3</span>, nsim<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span></code></pre></div>
<p>These plots can give some idea of how much risks might be expected to
vary over time. The parameter driving these variations is <span class="math inline">\(\sigma\)</span>, whose prior can be defined with
the <code>prior_hsd</code> argument to <code>survextrap</code>. In the
standard <code>survextrap</code> model, <span class="math inline">\(\sigma=0\)</span> means that we are sure that the
hazard will be constant. Therefore we might want to define the prior for
<span class="math inline">\(\sigma\)</span> to rule out implausibly
large changes. For example, a Gamma(2,20):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">haz_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/prior_sample_hazard.html">prior_sample_hazard</a></span><span class="op">(</span>knots<span class="op">=</span><span class="va">sp</span><span class="op">$</span><span class="va">knots</span>, degree<span class="op">=</span><span class="va">sp</span><span class="op">$</span><span class="va">degree</span>, </span>
<span>                               coefs_mean <span class="op">=</span> <span class="va">ndi_mod</span><span class="op">$</span><span class="va">coefs_mean</span>,   </span>
<span>                               prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">20</span><span class="op">)</span>,   </span>
<span>                               prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span>,</span>
<span>                             tmax<span class="op">=</span><span class="fl">3</span>, nsim<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">haz_sim</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>, y<span class="op">=</span><span class="va">haz</span>, group<span class="op">=</span><span class="va">rep</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Years"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Hazard"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span><span class="op">)</span></span></code></pre></div>
<p><img src="priors_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
<p>The choice of this prior might be important if we want to extrapolate
outside the data, while accounting for potential hazard changes outside
the data. If the data informing extrapolation are weak, then the
extrapolations will be sensitive to the prior for these potential hazard
changes.</p>
<p>Plotting multiple trajectories gives a rough idea of the typical
amount of variation through time, but , but ideally we want a more
quantitative summary of this.</p>
</div>
</div>
<div class="section level3">
<h3 id="hrsd">Ratio between high and low hazards over time<a class="anchor" aria-label="anchor" href="#hrsd"></a>
</h3>
<p>The variation in a hazard curve can be summarised simply by taking a
fine grid of equally-spaced points between the time boundary knots, and
computing the empirical standard deviation of the hazard on those
points. If the hazard is constant, then the SD will be zero.</p>
<p>Since the SD depends on the scale of the hazard, a more useful
measure of variation would be the ratio between a particularly high and
a particularly low hazard on this grid. High and low might be defined
from the 90% and 10% quantiles over time. If the hazard is constant,
over time, this ratio will be 1.</p>
<p>These measures are computed by the <code>haz_sd()</code> function:
the <code>sd_haz</code> component is the SD over time of the hazard,
<code>sd_mean</code> is the SD over time of the inverse hazard, and
<code>hr</code> is the high/low hazard ratio (90%/10% by default).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">ndi_mod</span><span class="op">$</span><span class="va">prior_sample</span><span class="op">$</span><span class="fu">haz_sd</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            sd_haz      sd_mean           hr</span></span>
<span><span class="co">## 2.5%  0.001515510 3.114473e+01 1.817126e+00</span></span>
<span><span class="co">## 50%   0.008722217 6.809896e+02 4.013356e+01</span></span>
<span><span class="co">## 97.5% 0.024717065 8.197922e+11 4.182825e+08</span></span></code></pre>
<p>This shows that the default Gamma<span class="math inline">\((a=2,b=1)\)</span> prior used in this model is
very vague. We can make it less vague by reducing <span class="math inline">\(a/b\)</span>. A Gamma(2, 5), for example, leads to
an upper 90% credible limit of about 5 for the hazard ratio over time.
Trial and error is probably necessary to produce a prior that is judged
plausible by this metric.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/prior_haz.html">prior_haz_sd</a></span><span class="op">(</span>mspline<span class="op">=</span><span class="va">sp</span>,                              </span>
<span>             prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">5</span><span class="op">)</span>,   </span>
<span>             prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span>, </span>
<span>             quantiles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.9</span><span class="op">)</span>,</span>
<span>             nsim<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           sd_haz    sd_mean       hr</span></span>
<span><span class="co">## 10% 0.0004542116   9.037567 1.080665</span></span>
<span><span class="co">## 50% 0.0018053422  37.800321 1.517070</span></span>
<span><span class="co">## 90% 0.0050991490 231.092233 4.620972</span></span></code></pre>
<p>Note that a large number of simulations <code>nsim</code> from the
prior may be required for a precise estimate of these tail quantiles,
and the distribution is skewed, so that the 95% credible limit may be
much higher than the 90% limit, for example.</p>
<p>Let us now fit a model and compare the posterior 95% credible
interval for this hazard ratio to the prior. The posterior interval is
narrower than the prior interval, showing the influence of the data.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="va">nd_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, fit_method<span class="op">=</span><span class="st">"mcmc"</span>,</span>
<span>                     chains<span class="op">=</span><span class="fl">1</span>, iter<span class="op">=</span><span class="fl">1000</span>,</span>
<span>                     prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/GammaDist.html" class="external-link">qgamma</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.975</span><span class="op">)</span>, <span class="fl">2</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nd_mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span><span class="op">==</span><span class="st">"hsd"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">lower</span>, <span class="va">upper</span><span class="op">)</span></span></code></pre></div>
<p>In practical applications, if the prior is suspected to be
influential, then the results of interest should be compared between
different reasonable priors.</p>
</div>
<div class="section level3">
<h3 id="hazard-ratios-for-effects-of-covariates">Hazard ratios for effects of covariates<a class="anchor" aria-label="anchor" href="#hazard-ratios-for-effects-of-covariates"></a>
</h3>
<p>Hazard ratios for effects of predictors in survival models are
commonly presented and discussed in practice, so prior judgements about
them may be easier to make, compared to the other parameters in
<code>survextrap</code> models.</p>
<p><code>survextrap</code> uses normal (or t) priors for the log hazard
ratio. The default is normal(0, 2.5). A utility <code><a href="../reference/prior_hr.html">prior_hr()</a></code>
is provided to check what credible interval on the hazard ratio scale is
implied by a particular prior for the log hazard ratio. This shows that
the default is actually very vague, and supports hazard ratios up to
148. The prior SD should be reduced if this is implausible and the
sample size is small enough that this would be influential.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prior_hr.html">prior_hr</a></span><span class="op">(</span><span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##         2.5%          50%        97.5% </span></span>
<span><span class="co">## 7.447254e-03 1.000000e+00 1.342777e+02</span></span></code></pre>
<p>Conversely, the function <code>p_hr</code> goes the other way round
and converts a prior median and upper 95% credible limit for the hazard
ratio to a normal prior on the log scale. This shows that we should use
a prior SD of 1.17 for the log HR if we wanted to give a low probability
(2.5%) to HRs above 10. <code>p_hr</code> returns a list in a the same
format as <code>p_normal</code>, which can be supplied directly to
<code>prior_loghr</code> argument of <code>survextrap</code> models.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/p_hr.html">p_hr</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">$</span><span class="va">scale</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1.17481</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prior_hr.html">prior_hr</a></span><span class="op">(</span><span class="fu"><a href="../reference/p_hr.html">p_hr</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">1</span>, upper<span class="op">=</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  2.5%   50% 97.5% </span></span>
<span><span class="co">##   0.1   1.0  10.0</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="sd-of-hazard-ratios-over-time-in-non-proportional-hazards-models">SD of hazard ratios over time in non-proportional hazards
models<a class="anchor" aria-label="anchor" href="#sd-of-hazard-ratios-over-time-in-non-proportional-hazards-models"></a>
</h3>
<p>The novel non-proportional hazards model in <code>survextrap</code>
works by modelling the spline coefficients in terms of covariates, as
well as the hazard scale parameter. The model is described in the <a href="methods.html#nonprop">methods vignette</a> and an example of
fitting one is given in the <a href="examples.html#nonprop">examples
vignette</a>.</p>
<p>The parameters that relate the covariates to the spline coefficients
do not have any direct interpretation in terms of how an effect of the
covariate on the hazard changes over time. In theory, the model allows
the hazard ratio to increase and decrease arbitrarily in a flexible way,
in the same manner as a spline function.</p>
<p>The parameter <span class="math inline">\(\tau\)</span> governs the
amount of flexibility in the hazard ratio function. With <span class="math inline">\(\tau=0\)</span> the model is a proportional
hazards model, and as <span class="math inline">\(\tau\)</span>
increases the hazard ratio becomes a more flexible function of time. The
exact value of <span class="math inline">\(\tau\)</span> does not have
an interpretation, but as we did for <span class="math inline">\(\sigma\)</span> <a href="#hrsd">above</a>, we can
use <em>simulation</em> to calibrate the prior so that it matches
plausible judgements.</p>
<p>This is done with the <code>prior_hr_sd</code> function, which works
for <span class="math inline">\(\tau\)</span> in the same way as
<code>prior_haz_sd</code> does for <span class="math inline">\(\sigma\)</span>. The new requirement here is that
the values of covariates should be supplied in <code>newdata</code> and
<code>newdata0</code>, and the associated regression model formula in
<code>formula</code>. The hazard ratio between <code>newdata</code> and
<code>newdata0</code> will be computed.</p>
<p>All the other priors should be supplied: <code>prior_hscale</code>
for <span class="math inline">\(\eta\)</span>, <code>prior_hsd</code>
for <span class="math inline">\(\sigma\)</span>, and
<code>prior_loghr</code> for the “baseline” hazard ratio to which the
non-proportionality effects are applied. The function will simulate from
the joint prior distribution of hazard ratios implied by all these
priors together with the one that we want to calibrate:
<code>prior_hrsd</code>, the Gamma prior for <span class="math inline">\(\tau\)</span>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prior_haz.html">prior_hr_sd</a></span><span class="op">(</span>mspline<span class="op">=</span><span class="va">sp</span>,                              </span>
<span>            prior_hsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">5</span><span class="op">)</span>,   </span>
<span>            prior_hscale <span class="op">=</span> <span class="fu"><a href="../reference/p_meansurv.html">p_meansurv</a></span><span class="op">(</span>median<span class="op">=</span><span class="fl">50</span>, upper<span class="op">=</span><span class="fl">80</span>, mspline<span class="op">=</span><span class="va">sp</span><span class="op">)</span>,</span>
<span>            prior_loghr <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_normal</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>,</span>
<span>            prior_hrsd <span class="op">=</span> <span class="fu"><a href="../reference/priors.html">p_gamma</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>,</span>
<span>            formula <span class="op">=</span> <span class="op">~</span> <span class="va">treat</span>,</span>
<span>            newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>            newdata0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>treat <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>            quantiles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>            nsim<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           sd_hr       hrr</span></span>
<span><span class="co">## 5%   0.01502037  1.453464</span></span>
<span><span class="co">## 95% 53.42515945 12.894767</span></span></code></pre>
<p>The <code>sd_hr</code> column is the standard deviation of the hazard
ratio, and the <code>hrr</code> column is the ratio between a high and a
low value (by default the 90% versus the 10% quantile, but these can be
customised with the <code>hq</code> argument). These quantities both
have their own implicit prior distributions. Since we supplied
<code>quantiles=c(0.05,0.95)</code>, then 90% prior credible intervals
for these two quantities are shown here. These should be checked for
consistency with beliefs, and the Gamma prior for <span class="math inline">\(\tau\)</span> (supplied as
<code>p_gamma(2,3)</code> revised if necessary.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
