<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="survextrap">
<title>Examples of using survextrap • survextrap</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Examples of using survextrap">
<meta property="og:description" content="survextrap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">survextrap</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.8.15</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cetuximab.html">Case study of using survextrap: cetuximab for head and neck cancer</a>
    <a class="dropdown-item" href="../articles/examples.html">Examples of using survextrap</a>
    <a class="dropdown-item" href="../articles/methods.html">Details of methods behind survextrap</a>
    <a class="dropdown-item" href="../articles/priors.html">Priors in survextrap models</a>
    <a class="dropdown-item" href="../articles/sbc.html">Simulation-based calibration of survextrap</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chjackson/survextrap/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Examples of using survextrap</h1>
                        <h4 data-toc-skip class="author">Christopher
Jackson <a href="mailto:chris.jackson@mrc-bsu.cam.ac.uk" class="email">chris.jackson@mrc-bsu.cam.ac.uk</a>
</h4>
            
            <h4 data-toc-skip class="date">2024-06-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/chjackson/survextrap/blob/HEAD/vignettes/examples.Rmd" class="external-link"><code>vignettes/examples.Rmd</code></a></small>
      <div class="d-none name"><code>examples.Rmd</code></div>
    </div>

    
    
<p>This vignette gives a quick tour of the features of the
<code>survextrap</code> package, showing how to use it to fit a range of
survival models. See the <a href="https://chjackson.github.io/survextrap/articles/cetuximab.html">cetuximab
case study</a> for a more in-depth demonstration of how it might be used
in a typical health technology assessment.</p>
<p>See the <a href="../index.html">README</a> for the design principles
of the package, and the <a href="methods.html">methods vignette</a> for
technical details of the methods.</p>
<div class="section level2">
<h2 id="examples">Examples<a class="anchor" aria-label="anchor" href="#examples"></a>
</h2>
<p>For these examples, we use a dataset of trial of chemotherapy for
colon cancer, provided as <code>colon</code> in the
<code>survival</code> package, with an outcome of recurrence-free
survival (<code>etype==1</code>), artificially censored at 3 years, and
restricted to a random 20% subset. This is provided as
<code>colons</code> in the <code>survextrap</code> package for
convenience.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chjackson/survextrap" class="external-link">survextrap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="fu">survminer</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survminer/man/ggsurvplot.html" class="external-link">ggsurvplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span><span class="op">)</span>, data<span class="op">=</span><span class="va">colons</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="section level3">
<h3 id="simplest-model-no-external-data">Simplest model: no external data<a class="anchor" aria-label="anchor" href="#simplest-model-no-external-data"></a>
</h3>
<p>The following is the simplest, default model in the package fitted to
the short-term trial data alone. No external data are supplied. After
three years (the maximum follow up time of the short term data) the
model assumes the hazard stays constant.</p>
<p>The plot shows the posterior median and 95% credible intervals for
the survival and hazard functions. The spline adapts to give a
practically perfect fit to the short-term data - note the Kaplan-Meier
curve is obscured by the fitted posterior median. Although the model
assumes the extrapolated hazard is constant, there is still a wide
uncertainty interval around this constant value. This might be thought
to be plausible.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nd_mod</span>, show_knots<span class="op">=</span><span class="cn">TRUE</span>, tmax<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
<p>The spline knots are shown as blue lines. We could allow for the
possibility of hazard changes beyond three years by placing spline knots
beyond this point.</p>
<p>The <code>mspline</code> argument is used to control the spline. Here
we create an additional knot outside the data, at 4 years.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_mod2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, chains<span class="op">=</span><span class="fl">1</span>, </span>
<span>                      mspline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>add_knots<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nd_mod2</span>, tmax<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>This increases the amount of uncertainty about the extrapolated
survival and hazard. The extrapolations are likely to be sensitive to
the choice of any knots placed outside the data.</p>
<p>A sensible guide is to place the upper knot at the latest time that
you are interested in modelling. Beyond this time, you either think the
hazard will not change, or any changes in the hazard do not matter for
the purpose of the model.</p>
<p>The priors should then be chosen to give a low probability that the
hazard varies outside the range thought reasonable, e.g. in terms of
orders of magnitude. The package should provide a nice way to convert
beliefs of this kind into priors.</p>
<p>But note that it is only necessary to extrapolate in this way, using
knots and default priors, if there is <strong>no substantive
information</strong> about the long term hazard!</p>
<p>In many practical situations of extrapolation in time-to-event
models, we do have information. For human survival, we at least know
that people do not tend to live much longer than 100 years. There are
usually data from national agencies about mortality of general
populations.</p>
<p>The idea of the package is to make this external information as
explicit as possible - ideally in the form of data.</p>
<div class="section level4">
<h4 id="tuning">Note on model tuning<a class="anchor" aria-label="anchor" href="#tuning"></a>
</h4>
<p>The <code>survextrap</code> function has various options which can be
used to fine-tune the basic model explained in the Methods vignette.
These options include the number of spline knots, the distribution on
the coefficients (<span class="math inline">\(p_i\)</span>), and the
prior placed on the amount of smoothness in this curve <span class="math inline">\(\sigma\)</span>.</p>
<p>It will not usually be necessary to tune these to obtain a model that
gives a survival curve that fits the observed data well, hence to
estimate the restricted mean survival time well. However they may not be
optimal in every case. See, for example, the cetuximab case study, where
a tighter prior was placed on <span class="math inline">\(\sigma\)</span>, and fewer knots were used.</p>
<p>Cross-validation can be used to determine whether tuning gives an
overall improvement in fit to the observed data (see “Model comparison”
below).</p>
<p>Work is ongoing to give some empirical evidence, based on simulation
studies, for what the most sensible default choice should be.</p>
<p>One particularly promising recent development in the package is the
choice of a “random walk” prior to smooth the spline basis coefficients.
Here this gives a smoother, more realistic-looking hazard curve than the
one above that was based on the default (“exchangeable”) prior.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd_modr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, chains<span class="op">=</span><span class="fl">1</span>, </span>
<span>                      smooth_model <span class="op">=</span> <span class="st">"random_walk"</span>,</span>
<span>                      mspline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>add_knots<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nd_modr</span>, tmax<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="convergence">Note on computation settings<a class="anchor" aria-label="anchor" href="#convergence"></a>
</h4>
<p>Most of the example models in this vignette have been specified using
computational approximations which allow the models to be fitted more
quickly, but at the cost of some inaccuracy. This has been done so that
the vignettes build more quickly. Specifically:</p>
<ul>
<li><p><code>chains=1</code> was set in the examples above. This defines
the number of chains used in the MCMC method to estimate the model. This
option can be left out in practice - in which case, four MCMC chains are
used, which is the default setting in the <code>rstan</code> engine that
the package uses, and is more reliable in practice. The number of
iterations per chain can also be set with the <code>iter</code>
argument, among other settings, see <code>stan()</code>.</p></li>
<li><p>Likewise, some models below are fitted using
<code>fit.method="opt"</code>. This uses an <a href="https://mc-stan.org/rstan/reference/stanmodel-method-optimizing.html" class="external-link">approximation
to the posterior</a>. This is OK for producing point estimates of the
parameters (the posterior mode is used - note this is likely to differ
from the mean or median) but the uncertainty will be only roughly
approximated. This is very useful for quick checks and model
development.</p></li>
<li><p>If using MCMC, make sure to check the diagnostics to ensure that
the fit has <em>converged</em> - the values of <code>rhat</code> in the
summary output (e.g. below) should not be more than 1.05 for each
parameter (<a href="https://mc-stan.org/rstan/reference/Rhat.html" class="external-link">see
here</a> for technical details).</p></li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">nd_mod</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">##   variable basis_num  median    lower   upper      sd  rhat ess_bulk</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> alpha           <span style="color: #BB0000;">NA</span> -<span style="color: #BB0000;">0.555</span>  -<span style="color: #BB0000;">0.789</span>   -<span style="color: #BB0000;">0.344</span>  0.114   1.00      902.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> coefs            1  0.025<span style="text-decoration: underline;">2</span>  0.008<span style="text-decoration: underline;">26</span>  0.036<span style="text-decoration: underline;">8</span> 0.007<span style="text-decoration: underline;">31</span> 1.01      421.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> coefs            2  0.026<span style="text-decoration: underline;">6</span>  0.001<span style="text-decoration: underline;">57</span>  0.068<span style="text-decoration: underline;">8</span> 0.017<span style="text-decoration: underline;">7</span>  1.00      469.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> coefs            3  0.076<span style="text-decoration: underline;">3</span>  0.022<span style="text-decoration: underline;">1</span>   0.193  0.044<span style="text-decoration: underline;">6</span>  0.999     696.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">5</span> coefs            4  0.095<span style="text-decoration: underline;">5</span>  0.007<span style="text-decoration: underline;">24</span>  0.233  0.055<span style="text-decoration: underline;">6</span>  0.999     440.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">6</span> coefs            5  0.096<span style="text-decoration: underline;">4</span>  0.026<span style="text-decoration: underline;">8</span>   0.217  0.049<span style="text-decoration: underline;">4</span>  1.01      500.</span></span></code></pre>
<div class="section level5">
<h5 id="divergences">Divergent transitions<a class="anchor" aria-label="anchor" href="#divergences"></a>
</h5>
<ul>
<li>If using MCMC, there may be a warning produced by Stan about
<code>divergent transitions after warmup</code>. This is a limitation of
the sampling algorithm, and can happen when the posterior distribution
is awkward to sample from. See the <a href="https://mc-stan.org/misc/warnings.html" class="external-link">Stan documentation</a> for
technical details. If there are only one or two divergent transitions,
the message is probably safe to ignore, but in any case the results
should be examined to ensure they make sense. With lots of divergent
transitions, it is safer to simplify the model, e.g. by using stronger
priors or fewer spline knots.</li>
</ul>
</div>
</div>
</div>
<div class="section level3">
<h3 id="restricted-mean-survival">Restricted mean survival<a class="anchor" aria-label="anchor" href="#restricted-mean-survival"></a>
</h3>
<p>The function <code>rmst</code> calculates the restricted mean
survival time (RMST) from a fitted model. Uncertainty is expressed by
using the MCMC sample of the model parameters, and calculating the mean
(or RMST) for each draw, which produces a sample from the posterior
distribution. The posterior median and credible intervals are computed
by summarising this sample.</p>
<p>For particular combinations of parameter values, the mean under the
model <code>nd_mod</code> cannot be calculated</p>
<p>Here we compute the restricted mean survival time <span class="math inline">\(RMST(t)\)</span> over three alternative time
limits <span class="math inline">\(t\)</span>: 3, 10 and 1000 years. The
upper 95% credible limit for <span class="math inline">\(RMST(1000)\)</span> is very large.</p>
<blockquote>
<p><strong>Note</strong>: <code>niter</code> controls how many
iterations of the MCMC sample (previously drawn by
<code>survextrap</code>) should be used to summarise the distribution.
This is artificially set to a small number in this example so that it
runs faster. This is OK for quick checks, but in practice for “final
results”, you should check there are enough iterations to get summaries
with the amount of precision you want, which will usually be 1000 or
more.</p>
</blockquote>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">nd_mod2</span>, t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">10</span>,<span class="fl">1000</span><span class="op">)</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 5</span></span></span>
<span><span class="co">##   variable     t median lower  upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst         3   2.20  2.04   2.34</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst        10   5.42  4.14   6.38</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> rmst      <span style="text-decoration: underline;">1</span>000  11.4   4.75 136.</span></span></code></pre>
<p>We do not really believe that the mean survival for this population
can be this large. This is evidence that the fitted model is
unrealistic, and we should have included external information to bound
the estimates of the mean within plausible values. This can be done with
external data.</p>
<blockquote>
<p><strong>Note</strong> also the <code>mean</code> function can be used
to get the mean survival time over an infinite time horizon. In
practice, this is sometimes numerically unstable, resulting in an error
message about a divergent integral. That would suggest that there is a
substantial posterior probability that the mean is infinite. This is
often a consequence of having not enough data to inform survival over an
infinite horizon.</p>
</blockquote>
</div>
<div class="section level3">
<h3 id="custom-posterior-summaries">Custom posterior summaries<a class="anchor" aria-label="anchor" href="#custom-posterior-summaries"></a>
</h3>
<p>The <code>summ_fns</code> argument can be used to specify any custom
summaries of the posterior distribution of quantities in
<code>survextrap</code> models. For example, to use the mean, median and
interquartile range, rather than the median and 95% credible
interval:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">nd_mod2</span>, t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">10</span>,<span class="fl">1000</span><span class="op">)</span>,</span>
<span>     summ_fns <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean<span class="op">=</span><span class="va">mean</span>, median<span class="op">=</span><span class="va">median</span>,</span>
<span>                     <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">.x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">0.75</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     niter<span class="op">=</span><span class="fl">50</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">##   variable     t  mean median `25%` `75%`</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst         3  2.19   2.19  2.16  2.23</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst        10  5.41   5.45  5.12  5.77</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> rmst      <span style="text-decoration: underline;">1</span>000 31.4   14.3   8.12 24.9</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="extrapolation-using-long-term-population-data">Extrapolation using long term population data<a class="anchor" aria-label="anchor" href="#extrapolation-using-long-term-population-data"></a>
</h3>
<p>Suppose we judge that after 5 years, the survival of these patients
will be the same as in the general population, and we have some data
describing the annual survival rates of a population who are similar to
this one, perhaps from matching to national statistics or registry data
by age and sex. We would construct it something like this (though fake
data are shown here).</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span><span class="op">)</span>, </span>
<span>                     stop <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">15</span>, <span class="fl">20</span>, <span class="fl">25</span><span class="op">)</span>, </span>
<span>                     n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>, </span>
<span>                     r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">40</span>, <span class="fl">30</span>, <span class="fl">20</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This is passed as the <code>external</code> argument to
<code>survextrap</code>. Extra knots are added at 10 and 25 years, to
allow for the possibility that the hazard function will change shape
during the times covered by the external data. The external data are
coarser than the individual data, and it would be impossible to identify
complex hazard variations from them, so there is no point in using more
than a couple of extra knots. If there is a concern that this knot
choice may influence the results, then sensitivity analysis is
advised.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nde_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, </span>
<span>                      chains<span class="op">=</span><span class="fl">1</span>, external <span class="op">=</span> <span class="va">extdat</span>,</span>
<span>                      mspline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>add_knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">10</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nde_mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">nde_mod</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">##   variable median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> mean       6.03  5.00  6.94</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">nde_mod</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">10</span>, <span class="fl">1000</span><span class="op">)</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 5</span></span></span>
<span><span class="co">##   variable     t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst         3   2.19  2.09  2.33</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst        10   4.97  4.23  5.56</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> rmst      <span style="text-decoration: underline;">1</span>000   6.03  5.00  6.94</span></span></code></pre>
<p>Including the external data gives a more confident extrapolation. The
mean is finite. RMST converges to the mean, as it is supposed to.</p>
<div class="section level4">
<h4 id="modelling-differences-between-the-trial-and-external-data">Modelling differences between the trial and external data<a class="anchor" aria-label="anchor" href="#modelling-differences-between-the-trial-and-external-data"></a>
</h4>
<p>The external data need not be from an identical population to one of
the arms of the trial data. If we can assume that the datasets are
related through a model, we can perform extrapolations under the
assumptions of that model.</p>
<p>A simple example is where the hazards are assumed to be proportional
between the trial and external data. To implement this, we could define
a binary factor covariate called <code>dataset</code> to identify each
of the two datasets.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">levs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"trial"</span>, <span class="st">"external"</span><span class="op">)</span></span>
<span><span class="va">colons</span><span class="op">$</span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"trial"</span>, level<span class="op">=</span><span class="va">levs</span><span class="op">)</span></span>
<span><span class="va">extdat</span><span class="op">$</span><span class="va">dataset</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="st">"external"</span>, level<span class="op">=</span><span class="va">levs</span><span class="op">)</span></span></code></pre></div>
<p>A proportional hazards model is defined by including this covariate
on the right hand side of the model formula in the
<code>survextrap</code> command. (See <a href="#covariates">Covariates</a> below for more about models with
covariates).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ndec_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">dataset</span>, data<span class="op">=</span><span class="va">colons</span>, </span>
<span>                      chains<span class="op">=</span><span class="fl">1</span>, external <span class="op">=</span> <span class="va">extdat</span>,</span>
<span>                      mspline <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>add_knots<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">10</span>, <span class="fl">25</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The effect of this covariate then describes the hazard ratio for the
external data compared to the trial data - in this artificial example,
no difference between the datasets is discernible.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ndec_mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span><span class="op">==</span><span class="st">"hr"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 9</span></span></span>
<span><span class="co">##   variable basis_num term            median lower upper    sd  rhat ess_bulk</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>            <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> hr              <span style="color: #BB0000;">NA</span> datasetexternal   1.06 0.280  6.26  1.89 0.999     341.</span></span></code></pre>
<p>Different predictions are now available for the trial and external
population, so in decision-making contexts you would need to consider
which is more relevant.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">ndec_mod</span>, t<span class="op">=</span><span class="fl">3</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">##   variable dataset      t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst     trial        3   2.21 2.07   2.33</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst     external     3   2.26 0.706  2.75</span></span></code></pre>
<p>If there are more covariates observed in the datasets, these might be
added to the model to explain any differences between the datasets.
Though caution is required as always when extrapolating outside the
data, to different populations as well as over time. To extrapolate we
would need to assume that all parameter estimates are valid outside the
data that they were estimated from.</p>
</div>
</div>
<div class="section level3">
<h3 id="expert-elicitation-on-the-long-term">Expert elicitation on the long term<a class="anchor" aria-label="anchor" href="#expert-elicitation-on-the-long-term"></a>
</h3>
<p>Information about long term survival could be elicited from experts.
To use this information about the model, we should also elicit the
expert’s <em>uncertainty</em>.</p>
<p>For example, we ask the expert to consider a set of people who have
survived for 10 years. How many of them would they expect to survive a
further 5 years? Through some kind of formal elicitation process, they
supply a best guess (median) of 30%, and a 95% credible interval of 10%
to 50%.</p>
<p>Using standard techniques from elicitation (<a href="https://shelf.sites.sheffield.ac.uk/" class="external-link">SHELF</a>) we can interpret
that as a <span class="math inline">\(Beta(6.6, 15.0)\)</span> prior
distribution for the survival probability.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">SHELF</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SHELF/man/fitdist.html" class="external-link">fitdist</a></span><span class="op">(</span>vals<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span><span class="op">)</span>, probs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span><span class="op">)</span>,</span>
<span>               lower<span class="op">=</span><span class="fl">0</span>, upper<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">$</span><span class="va">Beta</span></span></code></pre></div>
<pre><code><span><span class="co">##     shape1   shape2</span></span>
<span><span class="co">## 1 6.588104 14.96673</span></span></code></pre>
<p>We can interpret this as the posterior from having observed <span class="math inline">\(y=6\)</span> survivors out of <span class="math inline">\(n=20\)</span> people (recalling the posterior from
a <span class="math inline">\(Binomial(y, n)\)</span> combined with a
vague <span class="math inline">\(Beta(0.5, 0.5)\)</span> prior is <span class="math inline">\(Beta(y+0.5, n-y+0.5)\)</span>, and rounding <span class="math inline">\(n\)</span> and <span class="math inline">\(y\)</span> to whole numbers).</p>
<p>So the expert’s judgement is equivalent to the information in an
external dataset of the form:</p>
<table class="table">
<tr>
<th colspan="2">
Follow-up period
</th>
<th colspan="2">
Number
</th>
</tr>
<tr>
<th>
Start time <span class="math inline">\(t\)</span>
</th>
<th>
End time <span class="math inline">\(u\)</span>
</th>
<th>
Alive at <span class="math inline">\(t\)</span>
</th>
<th>
Still alive at <span class="math inline">\(u\)</span>
</th>
</tr>
<tr>
<td>
10
</td>
<td>
15
</td>
<td>
20
</td>
<td>
6
</td>
</tr>
</table>
<p>and we can use it in a <code>survextrap</code> model as follows:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, stop <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">15</span><span class="op">)</span>, </span>
<span>                     n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span><span class="op">)</span>, r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nde_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>,</span>
<span>                      chains<span class="op">=</span><span class="fl">1</span>, external <span class="op">=</span> <span class="va">extdat</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nde_mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">nde_mod</span>, niter <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 1 × 4</span></span></span>
<span><span class="co">##   variable median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> mean       5.10  4.36  6.57</span></span></code></pre>
<p>There is still substantial uncertainty about the mean, even with this
level of information, but comparing to the second model above
(<code>nd_mod2</code>), it is better than no information at all. More
investigation of the role of the knot placement here (blue lines in the
figure) might be wise - particularly the one at 15 years.</p>
<p>This approach might be extended to include elicited values from
multiple time points, or considering multiple experts. In each case the
elicited information can be converted straightforwardly into an
aggregate table for use in <code>survextrap</code>.</p>
</div>
<div class="section level3">
<h3 id="covariates">Covariates<a class="anchor" aria-label="anchor" href="#covariates"></a>
</h3>
<p><code>survextrap</code> uses a proportional hazards model to
represent covariates by default. In the example here, we model survival
by treatment group <code>rx</code>, which is a factor with three levels.
First fit a standard Cox model:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## coxph(formula = Surv(years, status) ~ rx, data = colons)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##              coef exp(coef) se(coef)      z      p</span></span>
<span><span class="co">## rxLev     -0.3919    0.6758   0.2597 -1.509 0.1313</span></span>
<span><span class="co">## rxLev+5FU -0.6740    0.5097   0.2800 -2.407 0.0161</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Likelihood ratio test=6.39  on 2 df, p=0.04088</span></span>
<span><span class="co">## n= 191, number of events= 82</span></span></code></pre>
<p>Then fit a <code>survextrap</code> model and extract the log hazard
ratios. These agree with the Cox model - as expected, as we are using a
proportional hazards model with a very flexible baseline hazard
function.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rxph_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons</span>, chains<span class="op">=</span><span class="fl">1</span>, refresh<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">rxph_mod</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span><span class="op">==</span><span class="st">"loghr"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 9</span></span></span>
<span><span class="co">##   variable basis_num term      median  lower  upper    sd  rhat ess_bulk</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> loghr           <span style="color: #BB0000;">NA</span> rxLev     -<span style="color: #BB0000;">0.394</span> -<span style="color: #BB0000;">0.894</span>  0.102 0.256  1.00     552.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> loghr           <span style="color: #BB0000;">NA</span> rxLev+5FU -<span style="color: #BB0000;">0.658</span> -<span style="color: #BB0000;">1.26</span>  -<span style="color: #BB0000;">0.124</span> 0.287  1.00     792.</span></span></code></pre>
<p>The posterior median survival curves (thick lines) agree with the
subgroup-specific Kaplan-Meier estimates (thin lines).</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxph_mod</span>, niter<span class="op">=</span><span class="fl">100</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
<p>Any number of covariates, categorical or continuous, can be
included.</p>
<p>We can also have covariates in the external data. If covariates are
included in the model formula, and an external dataset is supplied, then
we must specify covariate values for each row of the external dataset.
(If the covariates are factors, then they can be supplied as character
vectors in <code>external</code>, but the values should be taken from
the factor levels in the internal data [todo: this probably isn’t a
necessary restriction])</p>
<p>For example, the external data might be assumed to have the same
survival as the control group of the trial (corresponding to a value of
<code>"Obs"</code> for the variable <code>rx</code>).</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">extdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, stop <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">15</span><span class="op">)</span>, </span>
<span>                     n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">100</span><span class="op">)</span>, r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">40</span><span class="op">)</span>, </span>
<span>                     rx <span class="op">=</span> <span class="st">"Obs"</span><span class="op">)</span></span>
<span><span class="va">rxphe_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons</span>, </span>
<span>                      chains<span class="op">=</span><span class="fl">1</span>, external <span class="op">=</span> <span class="va">extdat</span>, refresh<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/rmst.html">rmst</a></span><span class="op">(</span><span class="va">rxphe_mod</span>, niter<span class="op">=</span><span class="fl">100</span>, t<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 6</span></span></span>
<span><span class="co">##   variable rx          t median lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> rmst     Obs        20   5.05  4.02  6.16</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> rmst     Lev        20   6.92  4.68  9.03</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> rmst     Lev+5FU    20   8.70  5.95 11.1</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxphe_mod</span>, niter<span class="op">=</span><span class="fl">100</span>, tmax<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-23-1.png" width="700"></p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_hazard.html">plot_hazard</a></span><span class="op">(</span><span class="va">rxphe_mod</span>, niter<span class="op">=</span><span class="fl">100</span>, tmax<span class="op">=</span><span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-23-2.png" width="700"></p>
<div class="section level4">
<h4 id="covariate-specific-outputs">Covariate-specific outputs<a class="anchor" aria-label="anchor" href="#covariate-specific-outputs"></a>
</h4>
<p>After fitting a model that includes covariates, to present
covariate-specific outputs, a <code>newdata</code> data frame is
supplied to output functions such as <code><a href="../reference/rmst.html">rmst()</a></code>,
<code><a href="../reference/survival.html">survival()</a></code> or <code><a href="../reference/hazard.html">hazard()</a></code>. This contains one row
for each different covariate value (or combination of covariate values)
for which outputs are required, in this case, the Observation and
Lev+5FU treatment groups.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>,<span class="st">"Lev+5FU"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span>, newdata<span class="op">=</span><span class="va">nd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 4 × 5</span></span></span>
<span><span class="co">##   rx          t median  lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> Obs         5  0.349 0.225  0.505</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> Obs        10  0.173 0.058<span style="text-decoration: underline;">9</span> 0.377</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> Lev+5FU     5  0.585 0.420  0.735</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">4</span> Lev+5FU    10  0.413 0.198  0.630</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="standardised-outputs">Standardised outputs<a class="anchor" aria-label="anchor" href="#standardised-outputs"></a>
</h4>
<p>In models with covariates, “standardised” outputs are defined by
averaging, or marginalising, over covariate values in some reference
population, rather than being conditional on a given covariate value. To
compute these, we first construct a data frame with one row for each
member of the reference population, and columns for the covariate
values. We then tell the output function to average the outputs over
this reference population, by applying the <code>standardise_to</code>
function to the population, and supplying the result as the
<code>newdata</code> argument.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ref_pop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Obs"</span>,<span class="st">"Lev+5FU"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span>, newdata <span class="op">=</span> <span class="fu"><a href="../reference/standardise_to.html">standardise_to</a></span><span class="op">(</span><span class="va">ref_pop</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">##       t median  lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     5  0.464 0.241  0.709</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>    10  0.286 0.072<span style="text-decoration: underline;">0</span> 0.599</span></span></code></pre>
<p>Here a reference population is defined that consists of 1 person in
the Observation treatment group and 1 person in the Lev+5FU group. As
expected, the marginal 5 and 10 year survival probabilities for this
population are about half way between the treatment-specific estimates
for these survival probabilities.</p>
<div class="section level5">
<h5 id="notes-on-computation-of-standardised-outputs">Notes on computation of standardised outputs<a class="anchor" aria-label="anchor" href="#notes-on-computation-of-standardised-outputs"></a>
</h5>
<p>Only the <em>distribution</em> of covariate values in the reference
population matters, and not the population <em>size</em>. For example,
the same result would have been obtained here from a reference
population with <span class="math inline">\(n\)</span> people in every
treatment group, for any <span class="math inline">\(n\)</span>.</p>
<p>If the reference population is larger, then computation will be
slower. The default procedure involves concatenating multiple MCMC
samples of <span class="math inline">\(R\)</span> parameter values into
one:</p>
<p><span class="math display">\[ (\theta^{(1)} |
\mathbf{x}_1,...,\theta^{(R)}|\mathbf{x}_1), ..., (\theta^{(1)} |
\mathbf{x}_M,...,\theta^{(R)}|\mathbf{x}_M) \]</span></p>
<p>where <span class="math inline">\(R\)</span> is the number of MCMC
samples obtained in the original <code>survextrap</code> fit (4000 with
the current default number of chains and iterations used by
<code>rstan</code>), <span class="math inline">\(M\)</span> is the size
of the reference population, and <span class="math inline">\(\mathbf{x}_j\)</span> is the vector of covariate
values for the <span class="math inline">\(j\)</span>th member of the
reference population. The output function is then evaluated for each
element of this concatenated sample, to obtain a sample of size <span class="math inline">\(R \times M\)</span> from the posterior of the
standardised output. If this sample is large, this may be
computationally intensive, particularly if the output function is slow
to evaluate (e.g. the RMST, which uses numerical integration).</p>
<p>In the example above, there was only one covariate, which was
categorical, and we just wanted a 50/50 balance of two groups. Therefore
a reference population of size 2 was sufficient to describe the
distribution of covariates. In more complex situations, e.g. with
continuous covariates, we might want a larger reference population to
characterise the distribution.</p>
<p>To save computation for standardised outputs with large reference
populations, an alternative computational method is available. This
works by drawing a random covariate value <span class="math inline">\(\mathbf{x}_r\)</span> from the reference
population for each MCMC iteration <span class="math inline">\(r\)</span>, and then evaluating the output
function for the corresponding parameter value <span class="math inline">\(\theta^{(r)} | \mathbf{x}_r\)</span>. The
resulting sample of outputs is then a sample of size <span class="math inline">\(R\)</span> from the posterior of the standardised
output:</p>
<p><span class="math display">\[ (\theta^{(1)} |
\mathbf{x}_1,...,\theta^{(R)}|\mathbf{x}_R) \]</span></p>
<p>This alternative method is invoked by setting the
<code>random=TRUE</code> argument to <code>standardise_to</code>,
e.g. </p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">rxph_mod</span>, t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>,<span class="fl">10</span><span class="op">)</span>, newdata <span class="op">=</span> <span class="fu"><a href="../reference/standardise_to.html">standardise_to</a></span><span class="op">(</span><span class="va">ref_pop</span>, random<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">##       t median  lower upper</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span>     5  0.464 0.241  0.709</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span>    10  0.286 0.072<span style="text-decoration: underline;">0</span> 0.599</span></span></code></pre>
<p>The results will then be dependent on the random number seed, so care
should be taken that enough MCMC iterations have been run in the
original <code>survextrap</code> call that the output is stable to the
required number of significant figures.</p>
</div>
</div>
<div class="section level4">
<h4 id="nonprop">Non-proportional hazards model<a class="anchor" aria-label="anchor" href="#nonprop"></a>
</h4>
<p>The flexible non-proportional hazards model described in the <a href="methods.html#nonprop">methods vignette</a> can be specified with
the <code>nonprop</code> argument. <code>nonprop=TRUE</code> gives all
covariates in the main model formula non-proportional hazards. A subset
of covariates can be given non-proportional hazards by passing a
different model formula as the <code>nonprop</code> argument.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rxnph_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">rx</span>, data<span class="op">=</span><span class="va">colons</span>, nonprop<span class="op">=</span><span class="cn">TRUE</span>, chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">rxnph_mod</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-27-1.png" width="700"></p>
<p>Note the non-constant separation between the posterior median hazard
curves from the three treatment groups.</p>
<p>In this example, the sample size in each treatment group and time
period is small, so this model is probably overfitted. While the
posterior median survival seems to fit poorly to the Kaplan-Meier
estimates in some regions, there is large uncertainty around these
estimates that isn’t shown in these plots.</p>
<p>The non-proportional hazards model is experimental. In theory, it can
be “tuned” by changing the number of spline basis terms and the knot
positions (through the <code>mspline</code> argument to
<code>survextrap</code>), or by changing the prior on the parameter
<span class="math inline">\(\sigma^{(np)}_s\)</span> that controls the
smoothness of the departures from proportional hazards
(<code>prior_sdnp</code> argument). But this has not been tested much in
practice.</p>
<p>If a plot of the posterior hazard ratio against time is desired, this
might be constructed by extracting samples from the posterior of the
hazard for different covariate values by using
<code>hazard(..., sample=TRUE)</code>, converting to samples from the
hazard ratio, and then summarising and plotting.</p>
<p>The functions <code><a href="../reference/hazard_ratio.html">hazard_ratio()</a></code> and
<code><a href="../reference/plot_hazard_ratio.html">plot_hazard_ratio()</a></code> can be used to calculate or plot the
ratio of hazards between two covariate values, as a function of time.
The covariate values are supplied in a data frame with two rows - all
covariates in the model should be included here (there is currently no
facility for standardised effect estimation).</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>rx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Lev+5FU"</span>,<span class="st">"Lev"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_hazard_ratio.html">plot_hazard_ratio</a></span><span class="op">(</span><span class="va">rxnph_mod</span>, newdata<span class="op">=</span><span class="va">nd</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">5</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-28-1.png" width="700"></p>
<p>In this example, the credible interval for the Lev+5FU / Lev hazard
ratio is wide, and does not suggest that the hazard ratio is
time-varying. This model may be overfitted around time 0.5 to 1 - fewer
knots may be preferable if this model is intended for description of
hazard trajectories.</p>
</div>
<div class="section level4">
<h4 id="treatment-effect-waning-models">Treatment effect waning models<a class="anchor" aria-label="anchor" href="#treatment-effect-waning-models"></a>
</h4>
<p>These are described in <a href="waning.html">their own
vignette</a>.</p>
</div>
</div>
<div class="section level3">
<h3 id="loocv">Model comparison<a class="anchor" aria-label="anchor" href="#loocv"></a>
</h3>
<p>The leave-one-out cross-validation method of the <a href="http://mc-stan.org/loo/" class="external-link"><code>loo</code></a> package is
automatically implemented for every model fitted with
<code>survextrap</code>, unless <code>survextrap(..., loo=FALSE)</code>
is used.</p>
<p>The cross-validation results are returned in the <code>loo</code> and
<code>loo_external</code> component of the fitted model object,
describing the fit of the model to the individual and external data
respectively. For the external data, “leave one out” refers to leaving
out a single individual’s outcome from the aggregate totals.</p>
<p>See <a href="https://mc-stan.org/loo/articles/loo2-example.html" class="external-link">the
loo vignette</a> for some information about how to interpret these.</p>
<p>Roughly, lower values of the <code>looic</code> statistic indicate
models with better predictive ability. This is demonstrated here by
comparing the proportional hazards model with the non-proportional
hazards model. <code>looic</code> is lower for the proportional hazards
model, suggesting that the non-proportional hazards model is worse for
prediction. It is likely to be excessively complicated for the data.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rxph_mod</span><span class="op">$</span><span class="va">loo</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Computed from 1000 by 191 log-likelihood matrix</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##          Estimate   SE</span></span>
<span><span class="co">## elpd_loo   -212.5 10.0</span></span>
<span><span class="co">## p_loo         8.2  0.5</span></span>
<span><span class="co">## looic       425.0 20.0</span></span>
<span><span class="co">## ------</span></span>
<span><span class="co">## Monte Carlo SE of elpd_loo is 0.1.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## All Pareto k estimates are good (k &lt; 0.5).</span></span>
<span><span class="co">## See help('pareto-k-diagnostic') for details.</span></span></code></pre>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rxnph_mod</span><span class="op">$</span><span class="va">loo</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Computed from 1000 by 191 log-likelihood matrix</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##          Estimate   SE</span></span>
<span><span class="co">## elpd_loo   -232.8 11.5</span></span>
<span><span class="co">## p_loo        29.4  2.5</span></span>
<span><span class="co">## looic       465.6 23.1</span></span>
<span><span class="co">## ------</span></span>
<span><span class="co">## Monte Carlo SE of elpd_loo is NA.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Pareto k diagnostic values:</span></span>
<span><span class="co">##                          Count Pct.    Min. n_eff</span></span>
<span><span class="co">## (-Inf, 0.5]   (good)     187   97.9%   247       </span></span>
<span><span class="co">##  (0.5, 0.7]   (ok)         3    1.6%   429       </span></span>
<span><span class="co">##    (0.7, 1]   (bad)        1    0.5%   39        </span></span>
<span><span class="co">##    (1, Inf)   (very bad)   0    0.0%   &lt;NA&gt;      </span></span>
<span><span class="co">## See help('pareto-k-diagnostic') for details.</span></span></code></pre>
<p>If the warning message
<code>"Some Pareto k diagnostic values are too high"</code> appears
after calling <code>survextrap</code>, it was produced by the
<code>loo</code> package. The fitted model is still valid, but the
cross-validation statistics may not be. See <a href="https://mc-stan.org/loo/articles/loo2-example.html" class="external-link">the loo
vignette</a> and the references from there for more explanation. This
happens for the non-proportional hazards model here - cross-validation
failed for 2 out of the 191 observations in the data.</p>
</div>
<div class="section level3">
<h3 id="cure_example">Cure models<a class="anchor" aria-label="anchor" href="#cure_example"></a>
</h3>
<p>The package provides a simulated dataset <code>curedata</code> with
an obvious cure fraction. Here we fit the cure models that are described
in the <a href="methods.html#cure_methods">methods vignette</a>.</p>
<p>The probability of cure for <code>x=0</code> is 0.5, and for
<code>x=1</code> 0.622 (so the log odds ratio is 0.5). The uncured
fraction follows a Weibull(1.5, 1.2) survival distribution.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">curedata</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-31-1.png" width="700"></p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">noncure_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">curedata</span>, fit_method <span class="op">=</span> <span class="st">"opt"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_survival.html">plot_survival</a></span><span class="op">(</span><span class="va">noncure_mod</span>,tmax<span class="op">=</span><span class="fl">5</span><span class="op">)</span> </span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-31-2.png" width="700"></p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cure_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">curedata</span>, chains<span class="op">=</span><span class="fl">1</span>, cure<span class="op">=</span><span class="cn">TRUE</span>, iter<span class="op">=</span><span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">cure_mod</span>, tmax<span class="op">=</span><span class="fl">10</span>, niter<span class="op">=</span><span class="fl">20</span><span class="op">)</span> </span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-31-3.png" width="700"></p>
<p>Covariates on the cure fraction can be supplied by putting a formula
in the <code>cure</code> argument. These will be modelled using logistic
regression.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">curec_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">t</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">curedata</span>, cure<span class="op">=</span><span class="op">~</span><span class="va">x</span>, fit_method<span class="op">=</span><span class="st">"opt"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">curec_mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">variable</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pcure"</span>, <span class="st">"logor_cure"</span>, <span class="st">"or_cure"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="color: #949494;"># A tibble: 3 × 10</span></span></span>
<span><span class="co">##   variable   basis_num term   mode median lower upper     sd  rhat ess_bulk</span></span>
<span><span class="co">##   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">## <span style="color: #BCBCBC;">1</span> pcure             <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>    0.481  0.481 0.382 0.584 0.049<span style="text-decoration: underline;">5</span>  1.00    <span style="text-decoration: underline;">2</span>007.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">2</span> logor_cure        <span style="color: #BB0000;">NA</span> x     0.778  0.782 0.205 1.34  0.291   1.00    <span style="text-decoration: underline;">1</span>995.</span></span>
<span><span class="co">## <span style="color: #BCBCBC;">3</span> or_cure           <span style="color: #BB0000;">NA</span> x     2.18   2.19  1.23  3.81  0.688   1.00    <span style="text-decoration: underline;">1</span>995.</span></span></code></pre>
<p>In this summary, <code>pcure</code> is the probability of cure at a
value of 0 for the covariate <code>x.</code></p>
</div>
<div class="section level3">
<h3 id="relsurv_examples">Additive hazards / relative survival models<a class="anchor" aria-label="anchor" href="#relsurv_examples"></a>
</h3>
<p>To implement an “additive hazards” (“relative survival”) model (see
the <a href="methods.html#relsurv_methods">methods vignette</a>), the
background hazard can be supplied alongside the data. This can be done
in two ways - note the meaning of the predictions from the model depends
on which of these specifications was used.</p>
<div class="section level4">
<h4 id="relsurv_example2">Background hazard defined at all times<a class="anchor" aria-label="anchor" href="#relsurv_example2"></a>
</h4>
<p>The recommended way is to build a data frame that defines the value
of the background hazard at all times. The hazard is assumed to be a
piecewise-constant function. The data frame has columns
<code>"hazard"</code> and <code>"time"</code>, and each row defines the
value of the hazard between the current time and the next time. The
first value of <code>"time"</code> should be 0, and the final row of the
data defines the hazard for all times greater than the last time. For
example:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">3</span>, <span class="fl">5</span>, <span class="fl">10</span><span class="op">)</span>, </span>
<span>                 hazard<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>When supplied to <code>survextrap</code>, this defines a full model
for overall hazard at any time.</p>
<p>In the recurring example model, suppose we have external data about
the background hazard that we use to extrapolate survival up to 15
years. This is represented in the data frame <code>bh</code> defined
above.</p>
<p>The “cause-specific” hazard represents death from colon cancer, and
the “background” hazard represents deaths from other causes. We suppose
that colon cancer deaths dominate in the shorter term covered by the
individual data (0-3 years), but the risk of death from other causes
increases gradually after that.</p>
<p>We fit one model <code>mod</code> that excludes this information, and
another model that includes it.</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, fit_method<span class="op">=</span><span class="st">"opt"</span><span class="op">)</span></span>
<span><span class="va">mod_bh</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, fit_method<span class="op">=</span><span class="st">"opt"</span>, backhaz<span class="op">=</span><span class="va">bh</span><span class="op">)</span></span></code></pre></div>
<p>The posterior medians of the survival and hazard functions under
<code>mod_bh</code> are overlaid on the posterior distributions from
<code>mod</code>. The fitted survival and hazard in the short term
agrees under both models, but the survival is worse in the long term
when the increase in the background hazard at times 3, 5 and 10 is
accounted for.</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_survival.html">plot_survival</a></span><span class="op">(</span><span class="va">mod</span>, tmax<span class="op">=</span><span class="fl">15</span>, niter<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="../reference/survival.html">survival</a></span><span class="op">(</span><span class="va">mod_bh</span>, tmax<span class="op">=</span><span class="fl">15</span>, niter<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>, x<span class="op">=</span><span class="va">t</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-35-1.png" width="700"></p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_hazard.html">plot_hazard</a></span><span class="op">(</span><span class="va">mod</span>, tmax<span class="op">=</span><span class="fl">15</span>, niter<span class="op">=</span><span class="fl">20</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_bh</span>, tmax<span class="op">=</span><span class="fl">15</span>, niter<span class="op">=</span><span class="fl">20</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>, x<span class="op">=</span><span class="va">t</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"red"</span>, lwd<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-35-2.png" width="700"></p>
<p>Note that this kind of relative survival model can also be used
together with a cure model. If both <code>cure</code> and
<code>backhaz</code> are specified, then the cure model is assumed to
apply to the cause-specific hazard. This will define a model where the
cause-specific hazard approaches zero, hence the overall hazard is
increasingly dominated by the background causes of death, as time
increases.</p>
</div>
<div class="section level4">
<h4 id="stratified-background-hazards">Stratified background hazards<a class="anchor" aria-label="anchor" href="#stratified-background-hazards"></a>
</h4>
<p>Commonly, population mortality statistics are available by age and
sex. If the same stratifying variables are recorded in the survival data
(either the trial or external data) then <code>survextrap</code> allows
the strata to be matched with the appropriate stratified background
hazards.</p>
<p>A simple example is shown here. Suppose the following background
hazard data are available, where people aged over 70 have 1.2 times the
mortality rate of the under-70s. The year of age is recorded in the
trial data <code>colons</code>, which we convert to an over/under 70
binary age group.</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bh_strata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">bh</span><span class="op">$</span><span class="va">time</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                        hazard <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">bh</span><span class="op">$</span><span class="va">hazard</span>, <span class="va">bh</span><span class="op">$</span><span class="va">hazard</span><span class="op">*</span><span class="fl">1.2</span><span class="op">)</span>,</span>
<span>                        agegroup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Under 70"</span>, <span class="st">"Over 70"</span><span class="op">)</span>,each<span class="op">=</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">colons</span><span class="op">$</span><span class="va">agegroup</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cut.html" class="external-link">cut</a></span><span class="op">(</span><span class="va">colons</span><span class="op">$</span><span class="va">age</span>, breaks<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">70</span>,<span class="cn">Inf</span><span class="op">)</span>, </span>
<span>                       right<span class="op">=</span><span class="cn">FALSE</span>, labels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Under 70"</span>,<span class="st">"Over 70"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bh_strata</span></span></code></pre></div>
<pre><code><span><span class="co">##   time hazard agegroup</span></span>
<span><span class="co">## 1    0  0.010 Under 70</span></span>
<span><span class="co">## 2    3  0.050 Under 70</span></span>
<span><span class="co">## 3    5  0.100 Under 70</span></span>
<span><span class="co">## 4   10  0.200 Under 70</span></span>
<span><span class="co">## 5    0  0.012  Over 70</span></span>
<span><span class="co">## 6    3  0.060  Over 70</span></span>
<span><span class="co">## 7    5  0.120  Over 70</span></span>
<span><span class="co">## 8   10  0.240  Over 70</span></span></code></pre>
<p>Then to run <code>survextrap</code> with a stratified background
hazard, we indicate the names of the stratifying variables in the
<code>backhaz_strata</code> argument. These variables must exist in both
<code>data</code> and <code>backhaz</code> (and <code>external</code> if
this is provided). Every row in <code>data</code> must have a row in
<code>backhaz</code> with a matching stratum value. (Note there can be
multiple stratifying variables, in which case we would specify, for
example <code>backhaz_strata = c("agegroup","sex")</code>).</p>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_bhs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colons</span>, fit_method<span class="op">=</span><span class="st">"opt"</span>,</span>
<span>                      backhaz<span class="op">=</span><span class="va">bh_strata</span>, backhaz_strata<span class="op">=</span><span class="st">"agegroup"</span><span class="op">)</span></span></code></pre></div>
<p>To present predictions from a model with a stratified background
hazard (e.g. RMST, hazard, survival), a <code>newdata</code> should be
supplied to indicate which strata to present the results for, in the
same manner as for models with covariates. Here the fitted hazard
function reflects the increased long-term risk for over-70s.</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>agegroup <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Over 70"</span>, <span class="st">"Under 70"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_hazard.html">plot_hazard</a></span><span class="op">(</span><span class="va">mod</span>, tmax<span class="op">=</span><span class="fl">15</span>, ci<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">mod_bhs</span>, newdata<span class="op">=</span><span class="va">nd</span>, tmax<span class="op">=</span><span class="fl">15</span>, niter<span class="op">=</span><span class="fl">300</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y<span class="op">=</span><span class="va">median</span>, x<span class="op">=</span><span class="va">t</span>, col<span class="op">=</span><span class="va">agegroup</span><span class="op">)</span>, lwd<span class="op">=</span><span class="fl">1.2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-38-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="relsurv_example1">Background hazard only defined at the event times<a class="anchor" aria-label="anchor" href="#relsurv_example1"></a>
</h4>
<p>An alternative approach is to supply the background hazard as an
extra column alongside the data. The name of this column is supplied
(unquoted) as the <code>backhaz</code> argument to
<code>survextrap</code>. This relies on fewer assumptions about the
background hazard, since only the hazard at the event times is used, and
the background hazard outside the time spanned by the individual data is
unspecified.</p>
<p>Here the background hazard at each event time is defined in an extra
column <code>"bh"</code> in the individual data.</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">colonsb</span> <span class="op">&lt;-</span> <span class="va">colons</span></span>
<span><span class="va">colonsb</span><span class="op">$</span><span class="va">bh</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">colons</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">modb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colonsb</span>, backhaz<span class="op">=</span><span class="st">"bh"</span>, chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>As in the previous specification, the parameter estimates in the
fitted model describe the excess or cause-specific hazard for the study
population. However, the <em>predictions</em> from the model
(e.g. fitted survival, hazard or mean survival) have a different meaning
here. Previously they described the overall hazard - we were able to do
this because we defined the hazard at all times. But now they describe
the excess hazard for the study population - we cannot predict overall
survival in general here, since we did not define the background hazard
at all times.</p>
<p>In the example below, the excess hazard from the relative hazard
model (with constant background 0.05) is shown in blue below the fitted
overall hazard from a model with no background adjustment. As expected,
the excess hazard is around 0.05 less than the overall hazard.</p>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/survextrap.html">survextrap</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">years</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data<span class="op">=</span><span class="va">colonsb</span>, chains<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_hazard.html">plot_hazard</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data<span class="op">=</span><span class="fu"><a href="../reference/hazard.html">hazard</a></span><span class="op">(</span><span class="va">modb</span><span class="op">)</span>, col<span class="op">=</span><span class="st">"blue"</span><span class="op">)</span></span></code></pre></div>
<p><img src="examples_files/figure-html/unnamed-chunk-40-1.png" width="700"></p>
</div>
<div class="section level4">
<h4 id="comparison-with-other-ways-of-supplying-external-data-in-survextrap">Comparison with other ways of supplying external data in
survextrap<a class="anchor" aria-label="anchor" href="#comparison-with-other-ways-of-supplying-external-data-in-survextrap"></a>
</h4>
<p>An alternative approach to modelling a study population and a
background population in <code>survextrap</code> would be to estimate
the background hazard from external aggregate data supplied as an
<code>external</code> argument. A covariate would be included which
takes a different value between the external data and the study data. By
default, the hazards would then be assumed to be proportional between
the study population and external population. Proportional hazards would
be a restrictive assumption, however. The flexible nonproportional
hazards model might be preferable.</p>
<p>The advantage of this alternative approach would be to account for
uncertainty about the background hazard. If the background hazard is not
uncertain, however, then the standard relative survival model would be
adequate, as the excess hazard is modelled flexibly. In theory, another
way to account for uncertainty in <code>backhaz</code> would be to place
independent priors on each of the <code>backhaz</code> terms (without
modelling <code>backhaz</code> as a parametric function of time) though
this is not currently implemented.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christopher Jackson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
